<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filigree Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');
  body { font-family: 'JetBrains Mono', 'Fira Code', monospace; background: #0F172A; color: #F1F5F9; }
  #cy { width: 100%; height: 100%; }
  .card { transition: all 0.15s ease; }
  .card:hover { background: #334155 !important; }
  .card:focus { outline: 2px solid #3B82F6; outline-offset: -2px; }
  .ready-border { border-left: 4px solid #10B981; }
  .scrollbar-thin::-webkit-scrollbar { width: 6px; }
  .scrollbar-thin::-webkit-scrollbar-track { background: #1E293B; }
  .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  .detail-panel { transition: transform 0.2s ease; }
  .kanban-col { min-width: 320px; }
  #refreshIndicator { transition: opacity 0.3s ease; }
  @keyframes stale-pulse { 0%,100% { border-left-color: #EF4444; } 50% { border-left-color: #7F1D1D; } }
  .aging-border { border-left: 4px solid #F59E0B; }
  .stale-border { border-left: 4px solid #EF4444; animation: stale-pulse 2s infinite; }
  .changed-flash { animation: flash 1s ease-out; }
  @keyframes flash { 0% { box-shadow: 0 0 8px rgba(59,130,246,0.5); } 100% { box-shadow: none; } }
  button, select, input[type="text"], input[type="checkbox"] { min-height: 36px; }
  @media (pointer: coarse) { button, select, input[type="text"] { min-height: 44px; min-width: 44px; } }
  button:focus-visible, select:focus-visible, input:focus-visible { outline: 2px solid #60A5FA; outline-offset: 2px; }
  .btn-loading { opacity: 0.6; pointer-events: none; }
  @media (max-width: 768px) {
    .kanban-col { min-width: 100% !important; }
    #detailPanel { width: 100% !important; }
    header { flex-wrap: wrap; gap: 0.5rem; }
    header > div:nth-child(2) { flex-wrap: wrap; }
    footer { flex-wrap: wrap; }
  }
  @media (min-width: 769px) and (max-width: 1200px) {
    #detailPanel { width: 450px !important; }
    .kanban-col { min-width: 280px; }
  }
</style>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { mono: ['JetBrains Mono', 'Fira Code', 'monospace'] },
    }
  }
}
</script>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">
<a href="#kanbanBoard" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:bg-blue-600 focus:text-white focus:px-3 focus:py-1 focus:rounded focus:z-50">Skip to content</a>

<!-- Top Nav -->
<header class="flex items-center justify-between px-4 py-2 bg-slate-800 border-b border-slate-700 shrink-0">
  <div class="flex items-center gap-4">
    <span class="text-base font-semibold text-blue-400">&#9670; Filigree</span>
    <button onclick="showCreateForm()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700" title="Create Issue">+ New</button>
    <div class="flex gap-1">
      <button id="btnGraph" onclick="switchView('graph')" class="px-3 py-1 rounded text-xs font-medium">Graph</button>
      <button id="btnKanban" onclick="switchView('kanban')" class="px-3 py-1 rounded text-xs font-medium">Kanban</button>
      <button id="btnMetrics" onclick="switchView('metrics')" class="px-3 py-1 rounded text-xs font-medium">Metrics</button>
      <button id="btnActivity" onclick="switchView('activity')" class="px-3 py-1 rounded text-xs font-medium">Activity</button>
      <button id="btnWorkflow" onclick="switchView('workflow')" class="px-3 py-1 rounded text-xs font-medium">Workflow</button>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="flex items-center gap-3">
    <button id="btnReady" onclick="toggleReady()" class="px-2 py-1 rounded text-xs font-medium bg-emerald-900/50 text-emerald-400 border border-emerald-700">
      &#9679; Ready (<span id="readyCount">0</span>)
    </button>
    <button id="btnBlocked" onclick="toggleBlocked()" class="px-2 py-1 rounded text-xs font-medium bg-slate-700 text-slate-400 border border-slate-600">
      &#128279; Blocked (<span id="blockedCount">0</span>)
    </button>
    <label for="filterPriority" class="text-xs text-slate-400 sr-only">Priority</label>
    <select id="filterPriority" onchange="applyFilters()" class="bg-slate-700 text-slate-200 text-xs rounded px-2 py-1 border border-slate-600">
      <option value="all">Priority: All</option>
      <option value="0-1">P0-P1</option>
      <option value="2">P2</option>
      <option value="3-4">P3-P4</option>
    </select>
    <label for="filterSearch" class="text-xs text-slate-400 sr-only">Search</label>
    <input id="filterSearch" type="text" placeholder="Search..." oninput="debouncedSearch()"
           class="bg-slate-700 text-slate-200 text-xs rounded px-3 py-1 border border-slate-600 w-40 focus:outline-none focus:border-blue-500">
    <button onclick="toggleMultiSelect()" id="btnMultiSelect" class="px-2 py-1 rounded text-xs font-medium bg-slate-700 text-slate-400 border border-slate-600">Select</button>
    <div class="flex gap-1 text-xs">
      <label class="flex items-center gap-1 text-slate-400"><input type="checkbox" id="filterOpen" checked onchange="applyFilters()" class="accent-blue-500"> Open</label>
      <label class="flex items-center gap-1 text-slate-400"><input type="checkbox" id="filterInProgress" checked onchange="applyFilters()" class="accent-blue-500"> Active</label>
      <label class="flex items-center gap-1 text-slate-400"><input type="checkbox" id="filterClosed" onchange="applyFilters()" class="accent-blue-500"> Closed</label>
    </div>
  </div>

  <div class="flex items-center gap-3 text-xs text-slate-400">
    <span id="refreshIndicator" class="opacity-0 text-blue-400">Refreshing...</span>
    <span id="healthBadge" onclick="showHealthBreakdown()" class="cursor-pointer px-2 py-0.5 rounded text-xs font-bold" title="System Health Score">--</span>
    <span>Open: <b id="statOpen" class="text-slate-200" aria-live="polite">0</b></span>
    <span>Active: <b id="statActive" class="text-slate-200" aria-live="polite">0</b></span>
    <span>Ready: <b id="statReady" class="text-emerald-400" aria-live="polite">0</b></span>
  </div>
</header>

<!-- Main content area -->
<div class="flex flex-1 overflow-hidden relative">
  <!-- Graph view -->
  <div id="graphView" class="flex-1 hidden flex flex-col">
    <div class="flex items-center gap-2 px-4 py-1 bg-slate-800/50 text-xs text-slate-400 border-b border-slate-700">
      <label class="flex items-center gap-1">
        <input type="checkbox" id="graphEpicsOnly" checked onchange="renderGraph()" class="accent-blue-500"> Epics only
      </label>
      <button onclick="graphFit()" class="px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600">Fit</button>
      <button id="btnCritPath" onclick="toggleCriticalPath()" class="px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600">Critical Path</button>
    </div>
    <div id="cy" class="flex-1"></div>
  </div>

  <!-- Kanban view -->
  <div id="kanbanView" class="flex-1 hidden flex flex-col">
    <div class="flex items-center gap-2 px-4 py-1 bg-slate-800/50 text-xs text-slate-400 border-b border-slate-700">
      <button id="btnStandard" onclick="switchKanbanMode('standard')" class="px-2 py-0.5 rounded">Standard</button>
      <button id="btnCluster" onclick="switchKanbanMode('cluster')" class="px-2 py-0.5 rounded">Cluster</button>
      <span class="text-slate-600">|</span>
      <select id="filterType" onchange="applyTypeFilter()" class="bg-slate-700 text-slate-200 text-xs rounded px-2 py-0.5 border border-slate-600">
        <option value="">All types</option>
      </select>
    </div>
    <div class="flex gap-4 p-4 flex-1 overflow-x-auto" id="kanbanBoard" role="region" aria-label="Kanban Board"></div>
  </div>

  <!-- Metrics view -->
  <div id="metricsView" class="flex-1 hidden overflow-y-auto p-6">
    <div class="max-w-3xl mx-auto">
      <div class="flex items-center gap-3 mb-6">
        <span class="text-base font-semibold text-slate-200">Flow Metrics</span>
        <select id="metricsDays" onchange="loadMetrics()" class="bg-slate-700 text-xs rounded px-2 py-1 border border-slate-600">
          <option value="7">7 days</option>
          <option value="30" selected>30 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
      <div id="metricsContent" class="text-slate-400 text-xs">Loading...</div>
    </div>
  </div>

  <!-- Activity view -->
  <div id="activityView" class="flex-1 hidden overflow-y-auto p-6">
    <div class="max-w-3xl mx-auto">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-base font-semibold text-slate-200">Recent Activity</span>
        <button onclick="loadActivity()" class="text-xs bg-slate-700 px-2 py-1 rounded hover:bg-slate-600">Refresh</button>
      </div>
      <div id="activityContent" class="text-slate-400 text-xs">Loading...</div>
    </div>
  </div>

  <!-- Workflow view -->
  <div id="workflowView" class="flex-1 hidden flex flex-col">
    <div class="flex items-center gap-2 px-4 py-1 bg-slate-800/50 text-xs text-slate-400 border-b border-slate-700">
      <label for="workflowType" class="text-xs text-slate-400">Type:</label>
      <select id="workflowType" onchange="loadWorkflow()" class="bg-slate-700 text-slate-200 text-xs rounded px-2 py-1 border border-slate-600">
        <option value="">Select type...</option>
      </select>
    </div>
    <div id="workflowCy" class="flex-1"></div>
  </div>

  <!-- Detail panel (slides in from right) -->
  <div id="detailPanel" role="complementary" aria-label="Issue Detail" class="detail-panel absolute top-0 right-0 h-full w-[500px] bg-slate-800 border-l border-slate-700 overflow-y-auto scrollbar-thin transform translate-x-full z-10">
    <div id="detailContent" class="p-5"></div>
  </div>
</div>

<!-- Stats bar -->
<footer class="flex items-center gap-4 px-4 py-1 bg-slate-800 border-t border-slate-700 text-xs text-slate-400 shrink-0">
  <span>Open: <b id="footOpen" class="text-slate-300">0</b></span>
  <span>In Progress: <b id="footActive" class="text-slate-300">0</b></span>
  <span>Ready: <b id="footReady" class="text-emerald-400">0</b></span>
  <span>Blocked: <b id="footBlocked" class="text-red-400">0</b></span>
  <span>Deps: <b id="footDeps" class="text-slate-300">0</b></span>
</footer>

<div id="batchBar" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 flex items-center gap-3 shadow-xl hidden z-20">
  <span id="batchCount" class="text-xs text-slate-300">0 selected</span>
  <button onclick="batchSetPriority()" class="text-xs bg-slate-700 px-2 py-1 rounded hover:bg-slate-600">Set Priority</button>
  <button onclick="batchCloseSelected()" class="text-xs bg-red-900/50 text-red-400 px-2 py-1 rounded border border-red-800 hover:bg-red-900">Close All</button>
  <button onclick="toggleMultiSelect()" class="text-xs text-slate-500 hover:text-slate-300">Cancel</button>
</div>

<div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2" aria-live="polite"></div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
var allIssues = [];
var allDeps = [];
var stats = null;
var issueMap = {};
var currentView = 'kanban';
var kanbanMode = 'standard';
var readyFilter = true;
var selectedIssue = null;
var cy = null;
var expandedEpics = new Set();
var detailHistory = [];
var selectedCards = new Set();
var multiSelectMode = false;

var CATEGORY_COLORS = { open: '#64748B', wip: '#3B82F6', done: '#9CA3AF' };
var PRIORITY_COLORS = { 0: '#EF4444', 1: '#F97316', 2: '#6B7280', 3: '#D1D5DB', 4: '#D1D5DB' };
var TYPE_ICONS = { bug: '\u{1F41B}', feature: '\u2728', task: '\u{1F4CB}', epic: '\u{1F4CA}', milestone: '\u{1F3AF}', step: '\u25B6' };
var typeTemplate = null;  // Cached type template for type-filtered kanban

// ---------------------------------------------------------------------------
// Data fetching
// ---------------------------------------------------------------------------
async function fetchData() {
  document.getElementById('refreshIndicator').style.opacity = '1';
  try {
    var results = await Promise.all([
      fetch('/api/issues'), fetch('/api/dependencies'), fetch('/api/stats')
    ]);
    allIssues = await results[0].json();
    allDeps = await results[1].json();
    stats = await results[2].json();
    issueMap = {};
    allIssues.forEach(function(i) { issueMap[i.id] = i; });
    trackChanges(allIssues);
    computeImpactScores();
    computeHealthScore();
    updateStats();
    render();
  } finally {
    setTimeout(function() {
      document.getElementById('refreshIndicator').textContent = 'Updated ' + new Date().toLocaleTimeString();
      document.getElementById('refreshIndicator').style.opacity = '0.5';
    }, 300);
  }
}

function updateStats() {
  if (!stats) return;
  var s = stats;
  var byCat = s.by_category || {};
  var open = byCat.open || 0;
  var active = byCat.wip || 0;
  document.getElementById('statOpen').textContent = open;
  document.getElementById('statActive').textContent = active;
  document.getElementById('statReady').textContent = s.ready_count;
  document.getElementById('readyCount').textContent = s.ready_count;
  document.getElementById('footOpen').textContent = open;
  document.getElementById('footActive').textContent = active;
  document.getElementById('footReady').textContent = s.ready_count;
  document.getElementById('footBlocked').textContent = s.blocked_count;
  document.getElementById('footDeps').textContent = s.total_dependencies;
  document.getElementById('blockedCount').textContent = s.blocked_count;
  populateTypeFilter();
}

// ---------------------------------------------------------------------------
// Filtering
// ---------------------------------------------------------------------------
function getFilteredIssues() {
  var items = allIssues.slice();
  var showOpen = document.getElementById('filterOpen').checked;
  var showActive = document.getElementById('filterInProgress').checked;
  var showClosed = document.getElementById('filterClosed').checked;
  items = items.filter(function(i) {
    var cat = i.status_category || 'open';
    if (cat === 'open' && !showOpen) return false;
    if (cat === 'wip' && !showActive) return false;
    if (cat === 'done' && !showClosed) return false;
    return true;
  });

  var prio = document.getElementById('filterPriority').value;
  if (prio === '0-1') items = items.filter(function(i) { return i.priority <= 1; });
  else if (prio === '2') items = items.filter(function(i) { return i.priority === 2; });
  else if (prio === '3-4') items = items.filter(function(i) { return i.priority >= 3; });

  if (searchResults !== null) {
    items = items.filter(function(i) { return searchResults.has(i.id); });
  }

  if (readyFilter) items.sort(function(a, b) {
    return (b.is_ready ? 1 : 0) - (a.is_ready ? 1 : 0) || a.priority - b.priority;
  });

  if (blockedFilter) {
    items = items.filter(function(i) {
      return (i.blocked_by || []).some(function(bid) {
        var b = issueMap[bid];
        return b && (b.status_category || 'open') !== 'done';
      });
    });
  }

  return items;
}

function applyFilters() { render(); }

function toggleReady() {
  readyFilter = !readyFilter;
  var btn = document.getElementById('btnReady');
  btn.className = readyFilter
    ? 'px-2 py-1 rounded text-xs font-medium bg-emerald-900/50 text-emerald-400 border border-emerald-700'
    : 'px-2 py-1 rounded text-xs font-medium bg-slate-700 text-slate-400 border border-slate-600';
  render();
}

var blockedFilter = false;
function toggleBlocked() {
  blockedFilter = !blockedFilter;
  if (blockedFilter) readyFilter = false;
  var btn = document.getElementById('btnBlocked');
  btn.className = blockedFilter
    ? 'px-2 py-1 rounded text-xs font-medium bg-red-900/50 text-red-400 border border-red-700'
    : 'px-2 py-1 rounded text-xs font-medium bg-slate-700 text-slate-400 border border-slate-600';
  render();
}

function toggleMultiSelect() {
  multiSelectMode = !multiSelectMode;
  if (!multiSelectMode) selectedCards.clear();
  var btn = document.getElementById('btnMultiSelect');
  btn.className = multiSelectMode
    ? 'px-2 py-1 rounded text-xs font-medium bg-blue-600 text-white'
    : 'px-2 py-1 rounded text-xs font-medium bg-slate-700 text-slate-400 border border-slate-600';
  render();
}

function toggleCardSelect(e, issueId) {
  if (!multiSelectMode) return;
  e.stopPropagation();
  if (selectedCards.has(issueId)) selectedCards.delete(issueId);
  else selectedCards.add(issueId);
  render();
}

// ---------------------------------------------------------------------------
// View switching
// ---------------------------------------------------------------------------
function switchView(view) {
  currentView = view;
  document.getElementById('graphView').classList.toggle('hidden', view !== 'graph');
  document.getElementById('kanbanView').classList.toggle('hidden', view !== 'kanban');
  document.getElementById('metricsView').classList.toggle('hidden', view !== 'metrics');
  document.getElementById('activityView').classList.toggle('hidden', view !== 'activity');
  document.getElementById('workflowView').classList.toggle('hidden', view !== 'workflow');
  document.getElementById('btnGraph').className = view === 'graph'
    ? 'px-3 py-1 rounded text-xs font-medium bg-blue-600 text-white'
    : 'px-3 py-1 rounded text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600';
  document.getElementById('btnKanban').className = view === 'kanban'
    ? 'px-3 py-1 rounded text-xs font-medium bg-blue-600 text-white'
    : 'px-3 py-1 rounded text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600';
  document.getElementById('btnMetrics').className = view === 'metrics'
    ? 'px-3 py-1 rounded text-xs font-medium bg-blue-600 text-white'
    : 'px-3 py-1 rounded text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600';
  document.getElementById('btnActivity').className = view === 'activity'
    ? 'px-3 py-1 rounded text-xs font-medium bg-blue-600 text-white'
    : 'px-3 py-1 rounded text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600';
  document.getElementById('btnWorkflow').className = view === 'workflow'
    ? 'px-3 py-1 rounded text-xs font-medium bg-blue-600 text-white'
    : 'px-3 py-1 rounded text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600';
  updateHash();
  if (view === 'graph') renderGraph();
  else if (view === 'metrics') loadMetrics();
  else if (view === 'activity') loadActivity();
  else if (view === 'workflow') loadWorkflow();
  else renderKanban();
}

function switchKanbanMode(mode) {
  kanbanMode = mode;
  document.getElementById('btnStandard').className = mode === 'standard'
    ? 'px-2 py-0.5 rounded bg-blue-600 text-white'
    : 'px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600';
  document.getElementById('btnCluster').className = mode === 'cluster'
    ? 'px-2 py-0.5 rounded bg-blue-600 text-white'
    : 'px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600';
  updateHash();
  renderKanban();
}

function render() {
  if (currentView === 'graph') renderGraph();
  else renderKanban();
  updateBatchBar();
}

// ---------------------------------------------------------------------------
// Kanban
// ---------------------------------------------------------------------------
function renderKanban() {
  var board = document.getElementById('kanbanBoard');
  var items = getFilteredIssues();

  // Type-filtered kanban: one column per type state, restricted to matching type
  if (typeTemplate) {
    var stateColumns = {};
    typeTemplate.states.forEach(function(s) { stateColumns[s.name] = []; });
    items.forEach(function(i) {
      if (i.type === typeTemplate.type && stateColumns[i.status]) stateColumns[i.status].push(i);
    });
    board.innerHTML = renderTypeKanban(stateColumns, typeTemplate);
    return;
  }

  // Default: 3-category columns (open/wip/done)
  var columns = { open: [], wip: [], done: [] };
  items.forEach(function(i) {
    var cat = i.status_category || 'open';
    if (columns[cat]) columns[cat].push(i);
  });

  if (kanbanMode === 'cluster') {
    board.innerHTML = renderClusterKanban(columns);
  } else {
    board.innerHTML = renderStandardKanban(columns);
  }
}

function renderStandardKanban(columns) {
  var colDefs = [
    { key: 'open', label: 'Open', color: '#64748B' },
    { key: 'wip', label: 'In Progress', color: '#3B82F6' },
    { key: 'done', label: 'Done', color: '#9CA3AF' },
  ];
  return colDefs.map(function(col) {
    var issues = columns[col.key] || [];
    return '<div class="kanban-col flex flex-col shrink-0">' +
      '<div class="flex items-center gap-2 mb-2 px-1">' +
        '<span class="w-2 h-2 rounded-full" style="background:' + col.color + '"></span>' +
        '<span class="font-medium text-xs text-slate-300">' + col.label + '</span>' +
        '<span class="text-xs text-slate-500">' + issues.length + '</span>' +
      '</div>' +
      '<div class="flex flex-col gap-2 overflow-y-auto scrollbar-thin pr-1" style="max-height: calc(100vh - 160px);">' +
        issues.map(function(i) { return renderCard(i); }).join('') +
      '</div></div>';
  }).join('');
}

function renderClusterKanban(columns) {
  var colDefs = [
    { key: 'open', label: 'Open', color: '#64748B' },
    { key: 'wip', label: 'In Progress', color: '#3B82F6' },
    { key: 'done', label: 'Done', color: '#9CA3AF' },
  ];
  return colDefs.map(function(col) {
    var issues = columns[col.key] || [];
    var epicIssues = issues.filter(function(i) {
      return (i.type === 'epic' || i.type === 'milestone') && i.children && i.children.length > 0;
    });
    var epicIds = new Set(epicIssues.map(function(i) { return i.id; }));
    var childIds = new Set();
    epicIssues.forEach(function(i) { (i.children || []).forEach(function(c) { childIds.add(c); }); });
    var orphans = issues.filter(function(i) { return !epicIds.has(i.id) && !childIds.has(i.id); });

    var epicCards = epicIssues.map(function(epic) { return renderClusterCard(epic); }).join('');
    var orphanCards = orphans.map(function(i) { return renderCard(i); }).join('');

    return '<div class="kanban-col flex flex-col shrink-0">' +
      '<div class="flex items-center gap-2 mb-2 px-1">' +
        '<span class="w-2 h-2 rounded-full" style="background:' + col.color + '"></span>' +
        '<span class="font-medium text-xs text-slate-300">' + col.label + '</span>' +
        '<span class="text-xs text-slate-500">' + issues.length + '</span>' +
      '</div>' +
      '<div class="flex flex-col gap-2 overflow-y-auto scrollbar-thin pr-1" style="max-height: calc(100vh - 160px);">' +
        epicCards + orphanCards +
      '</div></div>';
  }).join('');
}

function renderClusterCard(epic) {
  var children = (epic.children || []).map(function(cid) { return issueMap[cid]; }).filter(Boolean);
  var counts = { open: 0, wip: 0, done: 0 };
  children.forEach(function(c) { var cat = c.status_category || 'open'; if (counts[cat] !== undefined) counts[cat]++; });
  var total = children.length;
  var expanded = expandedEpics.has(epic.id);

  var pctOpen = total ? (counts.open / total * 100) : 0;
  var pctActive = total ? (counts.wip / total * 100) : 0;
  var pctClosed = total ? (counts.done / total * 100) : 0;

  var childHtml = '';
  if (expanded) {
    childHtml = '<div class="mt-2 ml-4 flex flex-col gap-1">' +
      children.map(function(c) { return renderCard(c); }).join('') + '</div>';
  }

  return '<div class="bg-slate-800 rounded border border-slate-700 p-3 cursor-pointer ' +
    (epic.is_ready ? 'ready-border' : '') +
    '" onclick="toggleEpicExpand(\'' + epic.id + '\')">' +
    '<div class="flex items-center justify-between mb-1">' +
      '<span class="text-xs">' + (TYPE_ICONS[epic.type] || '') +
        ' <span class="font-medium text-slate-200">' + escHtml(epic.title.slice(0, 40)) + '</span></span>' +
      '<span class="text-xs text-slate-500">[' + total + ']</span>' +
    '</div>' +
    '<div class="w-full h-2 rounded-full bg-slate-900 flex overflow-hidden mb-1">' +
      '<div style="width:' + pctClosed + '%;background:#9CA3AF"></div>' +
      '<div style="width:' + pctActive + '%;background:#3B82F6"></div>' +
      '<div style="width:' + pctOpen + '%;background:#64748B"></div>' +
    '</div>' +
    '<div class="text-xs text-slate-500">' + counts.open + ' open &middot; ' +
      counts.wip + ' active &middot; ' + counts.done + ' done</div>' +
    (expanded
      ? '<div class="text-xs text-blue-400 mt-1">&#9660; expanded</div>'
      : '<div class="text-xs text-slate-600 mt-1">&#9654; click to expand</div>') +
    childHtml +
  '</div>';
}

function renderCard(issue) {
  var typeIcon = TYPE_ICONS[issue.type] || '';
  var prioColor = PRIORITY_COLORS[issue.priority] || '#6B7280';
  var cat = issue.status_category || 'open';
  var catColor = CATEGORY_COLORS[cat] || '#64748B';
  var blockedCount = (issue.blocked_by || []).filter(function(bid) {
    var b = issueMap[bid];
    return b && (b.status_category || 'open') !== 'done';
  }).length;
  var readyClass = issue.is_ready && cat === 'open' ? 'ready-border' : '';

  var agingClass = '';
  if (cat === 'wip' && issue.updated_at) {
    var ageMs = Date.now() - new Date(issue.updated_at).getTime();
    var ageHours = ageMs / 3600000;
    if (ageHours > 24) agingClass = 'stale-border';
    else if (ageHours > 4) agingClass = 'aging-border';
  }

  var changedClass = changedIds.has(issue.id) ? 'ring-1 ring-blue-500' : '';

  var checkbox = multiSelectMode
    ? '<input type="checkbox" ' + (selectedCards.has(issue.id) ? 'checked' : '') +
      ' onclick="toggleCardSelect(event,\'' + issue.id + '\')" class="accent-blue-500 mr-1">'
    : '';

  return '<div class="card bg-slate-800 rounded border border-slate-700 p-3 cursor-pointer ' +
    readyClass + ' ' + agingClass + ' ' + changedClass + '" tabindex="0" data-id="' + issue.id + '" onclick="openDetail(\'' + issue.id + '\')">' +
    '<div class="flex items-center gap-2 mb-1">' +
      checkbox +
      '<span>' + typeIcon + '</span>' +
      '<span class="w-2 h-2 rounded-full shrink-0" style="background:' + prioColor +
        '" title="P' + issue.priority + '"></span>' +
      '<span class="font-medium text-slate-200 truncate">' + escHtml(issue.title.slice(0, 50)) + '</span>' +
    '</div>' +
    '<div class="flex items-center gap-2 text-xs text-slate-500">' +
      '<span>' + issue.id + '</span>' +
      '<span class="rounded px-1" style="background:' + catColor + ';color:white">' + issue.status + '</span>' +
      (blockedCount > 0 ? '<span class="text-red-400">\u{1F517} blocked by ' + blockedCount + '</span>' : '') +
      (impactScores[issue.id] > 0 ? '<span class="text-amber-400" title="Blocks ' + impactScores[issue.id] + ' downstream">\u26A1' + impactScores[issue.id] + '</span>' : '') +
      (issue.assignee ? '<span class="text-slate-400">\u{1F464} ' + escHtml(issue.assignee) + '</span>' : '') +
      (cat === 'wip' && issue.updated_at
        ? (function() {
            var mins = Math.floor((Date.now() - new Date(issue.updated_at).getTime()) / 60000);
            if (mins < 60) return '<span class="text-slate-500">' + mins + 'm</span>';
            var hrs = Math.floor(mins / 60);
            if (hrs < 24) return '<span class="' + (hrs > 4 ? 'text-amber-400' : 'text-slate-500') + '">' + hrs + 'h</span>';
            return '<span class="text-red-400">' + Math.floor(hrs / 24) + 'd</span>';
          })()
        : '') +
    '</div>' +
  '</div>';
}

function toggleEpicExpand(epicId) {
  if (expandedEpics.has(epicId)) expandedEpics.delete(epicId);
  else expandedEpics.add(epicId);
  renderKanban();
}

// ---------------------------------------------------------------------------
// Type-filtered kanban (WFT-FR-064)
// ---------------------------------------------------------------------------
function populateTypeFilter() {
  var select = document.getElementById('filterType');
  if (!select) return;
  var types = {};
  allIssues.forEach(function(i) { types[i.type] = true; });
  var currentVal = select.value;
  // Preserve first option, rebuild the rest
  select.innerHTML = '<option value="">All types</option>';
  Object.keys(types).sort().forEach(function(t) {
    var opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    select.appendChild(opt);
  });
  select.value = currentVal;
  // If the previously selected type no longer exists, the value silently
  // falls back to "".  Clear stale typeTemplate so renderKanban() shows
  // the default 3-category board instead of an empty type-specific board.
  if (select.value !== currentVal) {
    typeTemplate = null;
  }
}

var _typeFilterSeq = 0;  // Monotonic counter to ignore stale async responses
async function applyTypeFilter() {
  var typeName = document.getElementById('filterType').value;
  var seq = ++_typeFilterSeq;
  if (!typeName) {
    typeTemplate = null;
    renderKanban();
    return;
  }
  try {
    var resp = await fetch('/api/type/' + typeName);
    if (seq !== _typeFilterSeq) return;  // Superseded by newer selection
    if (resp.ok) {
      typeTemplate = await resp.json();
    } else {
      typeTemplate = null;
    }
  } catch (e) {
    if (seq !== _typeFilterSeq) return;
    typeTemplate = null;
  }
  renderKanban();
}

function renderTypeKanban(stateColumns, template) {
  return template.states.map(function(state) {
    var issues = stateColumns[state.name] || [];
    var catColor = CATEGORY_COLORS[state.category] || '#64748B';
    return '<div class="kanban-col flex flex-col shrink-0">' +
      '<div class="flex items-center gap-2 mb-2 px-1">' +
        '<span class="w-2 h-2 rounded-full" style="background:' + catColor + '"></span>' +
        '<span class="font-medium text-xs text-slate-300">' + state.name + '</span>' +
        '<span class="text-xs text-slate-500">' + issues.length + '</span>' +
      '</div>' +
      '<div class="flex flex-col gap-2 overflow-y-auto scrollbar-thin pr-1" style="max-height: calc(100vh - 160px);">' +
        issues.map(function(i) { return renderCard(i); }).join('') +
      '</div></div>';
  }).join('');
}

// ---------------------------------------------------------------------------
// Graph
// ---------------------------------------------------------------------------
function renderGraph() {
  if (!allIssues.length) return;
  var container = document.getElementById('cy');
  var epicsOnly = document.getElementById('graphEpicsOnly').checked;

  var showOpen = document.getElementById('filterOpen').checked;
  var showActive = document.getElementById('filterInProgress').checked;
  var showClosed = document.getElementById('filterClosed').checked;
  var search = document.getElementById('filterSearch').value.toLowerCase().trim();

  var visibleIds = new Set();
  allIssues.forEach(function(n) {
    var show = true;
    var cat = n.status_category || 'open';
    if (cat === 'open' && !showOpen) show = false;
    if (cat === 'wip' && !showActive) show = false;
    if (cat === 'done' && !showClosed) show = false;
    if (epicsOnly && n.type !== 'epic' && n.type !== 'milestone') show = false;
    if (show) visibleIds.add(n.id);
  });

  var cyNodes = allIssues.filter(function(n) { return visibleIds.has(n.id); }).map(function(n) {
    var matchesSearch = !search ||
      n.title.toLowerCase().indexOf(search) >= 0 ||
      n.id.toLowerCase().indexOf(search) >= 0;
    return {
      data: {
        id: n.id,
        label: n.title.length > 30 ? n.title.slice(0, 28) + '..' : n.title,
        status: n.status,
        statusCategory: n.status_category || 'open',
        priority: n.priority,
        type: n.type,
        isReady: n.is_ready,
        childCount: n.children ? n.children.length : 0,
        opacity: matchesSearch ? 1 : 0.2,
      }
    };
  });

  // allDeps: [{from: blocker_id, to: blocked_id, type}]
  // edge direction: from (blocker) -> to (blocked) i.e. source blocks target
  var cyEdges = allDeps.filter(function(e) {
    return visibleIds.has(e.from) && visibleIds.has(e.to);
  }).map(function(e, i) {
    return { data: { id: 'e' + i, source: e.from, target: e.to } };
  });

  if (cy) cy.destroy();
  cy = cytoscape({
    container: container,
    elements: cyNodes.concat(cyEdges),
    layout: { name: 'dagre', rankDir: 'TB', rankSep: 80, nodeSep: 40, padding: 20 },
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'font-size': '11px',
          'font-family': 'JetBrains Mono, monospace',
          'text-valign': 'center',
          'text-halign': 'center',
          'text-wrap': 'wrap',
          'text-max-width': '120px',
          'color': '#F1F5F9',
          'text-outline-color': '#0F172A',
          'text-outline-width': 2,
          'width': 'mapData(priority, 0, 4, 60, 35)',
          'height': 'mapData(priority, 0, 4, 60, 35)',
          'opacity': 'data(opacity)',
          'background-color': function(ele) { return CATEGORY_COLORS[ele.data('statusCategory')] || '#64748B'; },
          'border-width': function(ele) { return ele.data('isReady') ? 3 : 0; },
          'border-color': '#10B981',
          'shape': function(ele) {
            var t = ele.data('type');
            if (t === 'epic' || t === 'milestone') return 'hexagon';
            if (t === 'bug') return 'diamond';
            if (t === 'feature') return 'star';
            return 'round-rectangle';
          },
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 1.5,
          'line-color': '#475569',
          'target-arrow-color': '#475569',
          'target-arrow-shape': 'triangle',
          'curve-style': 'bezier',
          'arrow-scale': 0.8,
        }
      },
      {
        selector: 'node:selected',
        style: { 'border-width': 3, 'border-color': '#3B82F6' }
      }
    ],
    minZoom: 0.1,
    maxZoom: 4,
  });

  cy.on('tap', 'node', function(evt) { openDetail(evt.target.id()); });
  cy.fit(undefined, 30);

  if (criticalPathActive && criticalPathIds.size) {
    cy.nodes().forEach(function(n) {
      if (!criticalPathIds.has(n.id())) n.style('opacity', 0.2);
    });
    cy.edges().forEach(function(e) {
      if (criticalPathIds.has(e.source().id()) && criticalPathIds.has(e.target().id())) {
        e.style({'width': 3, 'line-color': '#EF4444', 'target-arrow-color': '#EF4444'});
      } else {
        e.style('opacity', 0.1);
      }
    });
  }

  cy.on('mouseover', 'node', function(evt) {
    if (criticalPathActive) return;
    var nodeId = evt.target.id();
    var downstream = new Set();
    var queue = [nodeId];
    while (queue.length) {
      var cur = queue.shift();
      cy.edges().forEach(function(e) {
        if (e.source().id() === cur && !downstream.has(e.target().id())) {
          downstream.add(e.target().id());
          queue.push(e.target().id());
        }
      });
    }
    if (downstream.size) {
      cy.nodes().forEach(function(n) {
        if (n.id() !== nodeId && !downstream.has(n.id())) n.style('opacity', 0.15);
      });
    }
  });
  cy.on('mouseout', 'node', function() {
    if (criticalPathActive) return;
    cy.nodes().forEach(function(n) { n.style('opacity', n.data('opacity')); });
  });
}

function graphFit() { if (cy) cy.fit(undefined, 30); }

// ---------------------------------------------------------------------------
// Detail Panel
// ---------------------------------------------------------------------------
async function openDetail(issueId) {
  if (selectedIssue && selectedIssue !== issueId) detailHistory.push(selectedIssue);
  selectedIssue = issueId;
  updateHash();
  var panel = document.getElementById('detailPanel');
  var content = document.getElementById('detailContent');

  content.innerHTML = '<div class="text-slate-500 text-xs">Loading...</div>';
  panel.classList.remove('translate-x-full');

  // Fetch full issue detail (includes events, comments, dep_details)
  var d = null;
  var eventsData = [];
  var commentsData = [];
  try {
    var resp = await fetch('/api/issue/' + issueId);
    if (!resp.ok) throw new Error('Not found');
    d = await resp.json();
    eventsData = d.events || [];
    commentsData = d.comments || [];
  } catch (e) {
    // Fall back to local data if detail endpoint fails
    d = issueMap[issueId];
    if (!d) {
      content.innerHTML = '<div class="text-red-400 text-xs">Issue not found</div>';
      return;
    }
  }

  var statusCat = d.status_category || 'open';
  var statusColor = CATEGORY_COLORS[statusCat] || '#64748B';
  var prioColor = PRIORITY_COLORS[d.priority] || '#6B7280';
  var typeIcon = TYPE_ICONS[d.type] || '';
  var depDetails = d.dep_details || {};
  // Show "state (category)" when they differ, e.g., "fixing (wip)"
  var statusLabel = d.status;
  if (statusCat !== d.status) statusLabel = d.status + ' (' + statusCat + ')';

  var blockerHtml = (d.blocked_by || []).map(function(bid) {
    var det = depDetails[bid] || issueMap[bid];
    if (!det) return '<div class="text-xs text-slate-500">' + bid + '</div>';
    var detCat = (det.status_category) || 'open';
    var sc = CATEGORY_COLORS[detCat] || '#64748B';
    return '<div class="flex items-center gap-2 text-xs">' +
      '<span class="w-2 h-2 rounded-full shrink-0" style="background:' + sc + '"></span>' +
      '<span class="cursor-pointer hover:text-blue-400 flex-1" onclick="openDetail(\'' + bid + '\')">' + escHtml(det.title.slice(0, 40)) + '</span>' +
      '<span class="text-slate-600">' + det.status + '</span>' +
      '<button onclick="event.stopPropagation();removeDependency(\'' + d.id + '\',\'' + bid + '\')" class="text-red-400 hover:text-red-300 ml-1" title="Remove dependency">&times;</button></div>';
  }).join('');

  var blocksHtml = (d.blocks || []).map(function(bid) {
    var det = depDetails[bid] || issueMap[bid];
    if (!det) return '<div class="text-xs text-slate-500">' + bid + '</div>';
    var detCat = (det.status_category) || 'open';
    var sc = CATEGORY_COLORS[detCat] || '#64748B';
    return '<div class="flex items-center gap-2 text-xs cursor-pointer hover:text-blue-400" onclick="openDetail(\'' + bid + '\')">' +
      '<span class="w-2 h-2 rounded-full" style="background:' + sc + '"></span>' +
      '<span>' + escHtml(det.title.slice(0, 40)) + '</span>' +
      '<span class="text-slate-600">' + det.status + '</span></div>';
  }).join('');

  var eventsHtml = eventsData.slice(0, 15).map(function(e) {
    return '<div class="text-xs text-slate-500 flex gap-2">' +
      '<span class="text-slate-600 shrink-0">' + (e.created_at ? e.created_at.slice(5, 16) : '') + '</span>' +
      '<span>' + escHtml(e.event_type) + (e.new_value ? ': ' + escHtml(e.new_value) : '') + '</span></div>';
  }).join('');

  var commentsHtml = commentsData.map(function(c) {
    return '<div class="bg-slate-900 rounded p-2 text-xs mb-1">' +
      '<div class="text-slate-400 mb-1">' + escHtml(c.author || 'anonymous') +
        ' &middot; ' + (c.created_at ? c.created_at.slice(0, 16) : '') + '</div>' +
      '<div class="text-slate-300">' + escHtml(c.text) + '</div></div>';
  }).join('');

  var openBlockers = (d.blocked_by || []).filter(function(bid) {
    var b = issueMap[bid];
    return b && (b.status_category || 'open') !== 'done';
  });
  var readyBadge = statusCat === 'open' && openBlockers.length === 0
    ? '<span class="text-xs bg-emerald-900/50 text-emerald-400 px-2 py-0.5 rounded">Ready</span>'
    : openBlockers.length > 0
      ? '<span class="text-xs bg-red-900/50 text-red-400 px-2 py-0.5 rounded">Blocked by ' + openBlockers.length + '</span>'
      : '';

  content.innerHTML =
    '<div class="flex items-center justify-between mb-3">' +
      '<span class="text-xs text-slate-500">' + d.id + '</span>' +
      '<div>' +
      (detailHistory.length
        ? '<button onclick="detailBack()" class="text-slate-500 hover:text-slate-300 text-xs mr-2">&larr; Back</button>'
        : '') +
      '<button onclick="closeDetail()" class="text-slate-500 hover:text-slate-300 text-lg" aria-label="Close detail panel">&times;</button>' +
      '</div>' +
    '</div>' +
    '<div class="flex items-center gap-2 mb-1">' +
      '<span class="text-lg">' + typeIcon + '</span>' +
      '<span class="text-lg font-semibold text-slate-100">' + escHtml(d.title) + '</span>' +
      ((d.type === 'milestone' || d.type === 'epic')
        ? '<button onclick="loadPlanView(\'' + d.id + '\')" class="text-xs bg-slate-700 px-2 py-1 rounded hover:bg-slate-600 ml-2">View Plan</button>'
        : '') +
    '</div>' +
    '<div class="flex items-center gap-2 mb-4 flex-wrap">' +
      '<span class="text-xs px-2 py-0.5 rounded" style="background:' + statusColor + ';color:white">' + statusLabel + '</span>' +
      '<span class="w-2 h-2 rounded-full" style="background:' + prioColor + '" title="P' + d.priority + '"></span>' +
      '<span class="text-xs text-slate-400">P' + d.priority + '</span>' +
      readyBadge +
      (d.assignee ? '<span class="text-xs text-slate-400">\u{1F464} ' + escHtml(d.assignee) + '</span>' : '') +
    '</div>' +
    (d.labels && d.labels.length
      ? '<div class="flex gap-1 mb-3 flex-wrap">' + d.labels.map(function(l) {
          return '<span class="text-xs bg-slate-700 text-slate-300 px-2 py-0.5 rounded">' + escHtml(l) + '</span>';
        }).join('') + '</div>'
      : '') +
    (d.description
      ? '<div class="mb-4"><div class="text-xs font-medium text-slate-400 mb-1">Description</div>' +
        '<div class="text-xs text-slate-300 leading-relaxed whitespace-pre-wrap">' + escHtml(d.description) + '</div></div>'
      : '') +
    (d.notes
      ? '<div class="mb-4"><div class="text-xs font-medium text-slate-400 mb-1">Notes</div>' +
        '<div class="text-xs text-slate-300 leading-relaxed whitespace-pre-wrap">' + escHtml(d.notes) + '</div></div>'
      : '') +
    ((d.blocked_by || []).length
      ? '<div class="mb-3"><div class="text-xs font-medium text-red-400 mb-1">Blocked by &larr;</div>' + blockerHtml +
        '<button onclick="showAddBlocker(\'' + d.id + '\')" class="text-xs text-blue-400 hover:underline mt-1">+ Add blocker</button></div>'
      : '<div class="mb-3"><button onclick="showAddBlocker(\'' + d.id + '\')" class="text-xs text-blue-400 hover:underline">+ Add blocker</button></div>') +
    ((d.blocks || []).length
      ? '<div class="mb-3"><div class="text-xs font-medium text-blue-400 mb-1">Blocks \u2192</div>' + blocksHtml + '</div>'
      : '') +
    (commentsData.length
      ? '<div class="mb-3"><div class="text-xs font-medium text-slate-400 mb-1">Comments</div>' + commentsHtml + '</div>'
      : '') +
    (eventsData.length
      ? '<div class="mb-3"><div class="text-xs font-medium text-slate-400 mb-1">Timeline</div>' + eventsHtml + '</div>'
      : '') +
    // Actions section
    '<div class="mt-4 border-t border-slate-700 pt-3">' +
      '<div class="text-xs font-medium text-slate-400 mb-2">Actions</div>' +
      '<div id="transitionBtns" class="flex flex-wrap gap-1 mb-2"></div>' +
      '<div class="flex gap-2 mb-2">' +
        '<label for="prioSelect" class="text-xs text-slate-400">Priority</label> ' +
        '<select id="prioSelect" onchange="updateIssue(\'' + d.id + '\', {priority: parseInt(this.value)})" class="bg-slate-700 text-xs rounded px-2 py-1 border border-slate-600">' +
          [0,1,2,3,4].map(function(p) {
            return '<option value="' + p + '"' + (d.priority === p ? ' selected' : '') + '>P' + p + '</option>';
          }).join('') +
        '</select>' +
        '<label for="assigneeInput" class="text-xs text-slate-400">Assignee</label> ' +
        '<input id="assigneeInput" type="text" placeholder="Assignee" value="' + escHtml(d.assignee || '') + '"' +
          ' onkeydown="if(event.key===\'Enter\')updateIssue(\'' + d.id + '\',{assignee:this.value})"' +
          ' class="bg-slate-700 text-xs rounded px-2 py-1 border border-slate-600 flex-1">' +
      '</div>' +
      (statusCat !== 'done'
        ? '<button onclick="closeIssue(\'' + d.id + '\')" class="text-xs bg-red-900/50 text-red-400 px-3 py-1 rounded border border-red-800 hover:bg-red-900 mb-2">Close</button>'
        : '<button onclick="reopenIssue(\'' + d.id + '\')" class="text-xs bg-green-900/50 text-green-400 px-3 py-1 rounded border border-green-800 hover:bg-green-900 mb-2">Reopen</button>') +
      (statusCat !== 'done' && !d.assignee
        ? '<button onclick="claimIssue(\'' + d.id + '\')" class="text-xs bg-emerald-900/50 text-emerald-400 px-3 py-1 rounded border border-emerald-800 hover:bg-emerald-900 mb-2 ml-1">Claim</button>'
        : '') +
      (d.assignee
        ? '<button onclick="releaseIssue(\'' + d.id + '\')" class="text-xs bg-slate-700 text-slate-300 px-3 py-1 rounded border border-slate-600 hover:bg-slate-600 mb-2 ml-1">Release</button>'
        : '') +
    '</div>' +
    // Comment input
    '<div class="mt-3 border-t border-slate-700 pt-3">' +
      '<label for="commentInput" class="text-xs font-medium text-slate-400 mb-1">Add Comment</label>' +
      '<div class="flex gap-1">' +
        '<input id="commentInput" type="text" placeholder="Comment..." onkeydown="if(event.key===\'Enter\')addComment(\'' + d.id + '\')"' +
          ' class="bg-slate-700 text-xs rounded px-2 py-1 border border-slate-600 flex-1 focus:outline-none focus:border-blue-500">' +
        '<button onclick="addComment(\'' + d.id + '\')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Send</button>' +
      '</div>' +
    '</div>' +
    '<div class="mt-3 text-xs text-slate-600 select-all">filigree show ' + d.id + '</div>';

  // Load transitions async and render buttons
  loadTransitions(issueId).then(function(transitions) {
    var container = document.getElementById('transitionBtns');
    if (!container || !transitions.length) return;
    container.innerHTML = transitions.map(function(t) {
      var cls = t.ready
        ? 'bg-blue-600 text-white hover:bg-blue-700'
        : 'bg-slate-700 text-slate-400 cursor-not-allowed';
      var title = t.missing_fields.length ? 'Missing: ' + t.missing_fields.join(', ') : '';
      return '<button ' + (t.ready ? 'onclick="updateIssue(\'' + issueId + '\',{status:\'' + t.to + '\'},this)"' : 'disabled') +
        ' class="text-xs px-2 py-1 rounded ' + cls + '" title="' + escHtml(title) + '">' +
        t.to + '</button>';
    }).join('');
  });

  trapFocus(document.getElementById('detailPanel'));
}

function closeDetail() {
  selectedIssue = null;
  detailHistory = [];
  document.getElementById('detailPanel').classList.add('translate-x-full');
  updateHash();
}

function detailBack() {
  if (detailHistory.length) {
    var prev = detailHistory.pop();
    selectedIssue = null; // prevent pushing to history again
    openDetail(prev);
  }
}

// ---------------------------------------------------------------------------
// URL hash state
// ---------------------------------------------------------------------------
function updateHash() {
  var hash = '#' + currentView;
  if (currentView === 'kanban' && kanbanMode === 'cluster') hash = '#kanban-cluster';
  if (selectedIssue) hash += '&issue=' + selectedIssue;
  history.replaceState(null, '', hash);
}

function parseHash() {
  var hash = location.hash.slice(1);
  var parts = hash.split('&');
  var view = parts[0] || 'kanban';
  if (view === 'graph') currentView = 'graph';
  else if (view === 'metrics') currentView = 'metrics';
  else if (view === 'activity') currentView = 'activity';
  else if (view === 'workflow') currentView = 'workflow';
  else if (view === 'kanban-cluster') { currentView = 'kanban'; kanbanMode = 'cluster'; }
  else { currentView = 'kanban'; kanbanMode = 'standard'; }

  var issuePart = parts.find(function(p) { return p.indexOf('issue=') === 0; });
  if (issuePart) selectedIssue = issuePart.split('=')[1];
}

// ---------------------------------------------------------------------------
// Keyboard shortcuts
// ---------------------------------------------------------------------------
document.addEventListener('keydown', function(e) {
  var active = document.activeElement;
  if (active && (active.tagName === 'INPUT' || active.tagName === 'SELECT' || active.tagName === 'TEXTAREA')) return;

  if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    document.getElementById('filterSearch').focus();
    return;
  }
  if (e.key === 'Escape') {
    if (selectedIssue) closeDetail();
    else { document.getElementById('filterSearch').value = ''; searchResults = null; applyFilters(); }
    return;
  }

  // j/k navigation
  if (e.key === 'j' || e.key === 'k') {
    var cards = Array.from(document.querySelectorAll('.card[tabindex]'));
    if (!cards.length) return;
    var idx = cards.indexOf(active);
    if (e.key === 'j') idx = Math.min(idx + 1, cards.length - 1);
    else idx = Math.max(idx - 1, 0);
    cards[idx].focus();
    return;
  }

  // Enter to open detail
  if (e.key === 'Enter' && active && active.classList.contains('card')) {
    var id = active.getAttribute('data-id');
    if (id) openDetail(id);
    return;
  }

  // Shortcuts when detail panel is open
  if (selectedIssue) {
    if (e.key === 'c') { var ci = document.getElementById('commentInput'); if (ci) { e.preventDefault(); ci.focus(); } }
    if (e.key === 'x') { e.preventDefault(); closeIssue(selectedIssue); }
  }
});

// ---------------------------------------------------------------------------
// Visibility-change refresh
// ---------------------------------------------------------------------------
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) fetchData();
});

// ---------------------------------------------------------------------------
// Utilities
// ---------------------------------------------------------------------------
function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function setLoading(el, loading) {
  if (!el) return;
  if (loading) { el.classList.add('btn-loading'); el.dataset.origText = el.textContent; el.textContent = 'Saving...'; }
  else { el.classList.remove('btn-loading'); if (el.dataset.origText) { el.textContent = el.dataset.origText; delete el.dataset.origText; } }
}

function showToast(message, type) {
  var container = document.getElementById('toastContainer');
  var toast = document.createElement('div');
  var bg = type === 'error' ? 'bg-red-900/90 border-red-700 text-red-200'
         : type === 'success' ? 'bg-emerald-900/90 border-emerald-700 text-emerald-200'
         : 'bg-slate-800/90 border-slate-600 text-slate-200';
  toast.className = 'px-4 py-2 rounded border text-xs shadow-lg ' + bg;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 4000);
}

// ---------------------------------------------------------------------------
// Actions (write operations)
// ---------------------------------------------------------------------------
async function updateIssue(issueId, body, btnEl) {
  if (btnEl) setLoading(btnEl, true);
  try {
    var resp = await fetch('/api/issue/' + issueId, {
      method: 'PATCH', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body),
    });
    if (!resp.ok) {
      var err = await resp.json();
      showToast('Error: ' + (err.error || 'Update failed'), 'error');
      return null;
    }
    var updated = await resp.json();
    await fetchData();
    if (selectedIssue === issueId) openDetail(issueId);
    return updated;
  } catch (e) { showToast('Network error', 'error'); return null; }
  finally { if (btnEl) setLoading(btnEl, false); }
}

async function closeIssue(issueId) {
  var existing = document.getElementById('closeReasonModal');
  if (existing) existing.remove();
  var modal = document.createElement('div');
  modal.id = 'closeReasonModal';
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = '<div class="bg-slate-800 rounded-lg border border-slate-600 p-4 w-80 shadow-xl">' +
    '<div class="text-sm text-slate-200 mb-2">Close reason (optional)</div>' +
    '<input id="closeReasonInput" type="text" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-3 py-2 border border-slate-600 mb-3 focus:outline-none focus:border-blue-500">' +
    '<div class="flex justify-end gap-2">' +
      '<button id="closeReasonCancel" class="text-xs bg-slate-700 px-3 py-1.5 rounded hover:bg-slate-600">Cancel</button>' +
      '<button id="closeReasonConfirm" class="text-xs bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700">Close Issue</button>' +
    '</div></div>';
  document.body.appendChild(modal);
  document.getElementById('closeReasonInput').focus();
  document.getElementById('closeReasonCancel').onclick = function() { modal.remove(); };
  modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
  document.getElementById('closeReasonConfirm').onclick = async function() {
    var reason = document.getElementById('closeReasonInput').value || '';
    modal.remove();
    var resp = await fetch('/api/issue/' + issueId + '/close', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({reason: reason}),
    });
    if (!resp.ok) { var err = await resp.json(); showToast('Error: ' + (err.error || 'Close failed'), 'error'); return; }
    showToast('Issue closed', 'success');
    await fetchData();
    if (selectedIssue === issueId) openDetail(issueId);
  };
}

async function reopenIssue(issueId) {
  var resp = await fetch('/api/issue/' + issueId + '/reopen', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({}),
  });
  if (!resp.ok) { var err = await resp.json(); showToast('Error: ' + (err.error || 'Reopen failed'), 'error'); return; }
  await fetchData();
  if (selectedIssue === issueId) openDetail(issueId);
}

async function claimIssue(issueId) {
  var name = window.prompt('Claim as:');
  if (!name) return;
  var resp = await fetch('/api/issue/' + issueId + '/claim', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({assignee: name}),
  });
  if (!resp.ok) { var err = await resp.json(); showToast('Error: ' + (err.error || 'Claim failed'), 'error'); return; }
  showToast('Claimed by ' + name, 'success');
  await fetchData();
  if (selectedIssue === issueId) openDetail(issueId);
}

async function releaseIssue(issueId) {
  var resp = await fetch('/api/issue/' + issueId + '/release', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({}),
  });
  if (!resp.ok) { var err = await resp.json(); showToast('Error: ' + (err.error || 'Release failed'), 'error'); return; }
  showToast('Issue released', 'success');
  await fetchData();
  if (selectedIssue === issueId) openDetail(issueId);
}

async function removeDependency(issueId, depId) {
  var resp = await fetch('/api/issue/' + issueId + '/dependencies/' + depId, { method: 'DELETE' });
  if (!resp.ok) { var err = await resp.json(); showToast('Error: ' + (err.error || 'Remove failed'), 'error'); return; }
  showToast('Dependency removed', 'success');
  await fetchData();
  if (selectedIssue === issueId) openDetail(issueId);
}

async function showAddBlocker(issueId) {
  var existing = document.getElementById('addBlockerModal');
  if (existing) existing.remove();
  var modal = document.createElement('div');
  modal.id = 'addBlockerModal';
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = '<div class="bg-slate-800 rounded-lg border border-slate-600 p-4 w-80 shadow-xl">' +
    '<div class="text-sm text-slate-200 mb-2">Add Blocker</div>' +
    '<input id="blockerSearchInput" type="text" placeholder="Search issues..." ' +
      'class="w-full bg-slate-700 text-slate-200 text-xs rounded px-3 py-2 border border-slate-600 mb-2 focus:outline-none focus:border-blue-500">' +
    '<div id="blockerResults" class="max-h-48 overflow-y-auto text-xs"></div>' +
    '<button onclick="document.getElementById(\'addBlockerModal\').remove()" class="text-xs text-slate-500 mt-2 hover:text-slate-300">Cancel</button>' +
    '</div>';
  document.body.appendChild(modal);
  modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
  var input = document.getElementById('blockerSearchInput');
  input.focus();
  var _searchTimeout2 = null;
  input.oninput = function() {
    clearTimeout(_searchTimeout2);
    _searchTimeout2 = setTimeout(async function() {
      var q = input.value.trim();
      var results = document.getElementById('blockerResults');
      if (!q) { results.innerHTML = ''; return; }
      try {
        var resp = await fetch('/api/search?q=' + encodeURIComponent(q) + '&limit=10');
        var data = await resp.json();
        results.innerHTML = data.results.filter(function(r) { return r.id !== issueId; }).map(function(r) {
          return '<div class="flex items-center gap-2 py-1 px-1 cursor-pointer hover:bg-slate-700 rounded" onclick="addDependency(\'' + issueId + '\',\'' + r.id + '\')">' +
            '<span class="text-slate-400">' + r.id + '</span>' +
            '<span class="text-slate-300 truncate">' + escHtml(r.title.slice(0, 30)) + '</span></div>';
        }).join('') || '<div class="text-slate-500">No results</div>';
      } catch(e) { results.innerHTML = '<div class="text-red-400">Search failed</div>'; }
    }, 200);
  };
}

async function addDependency(issueId, dependsOnId) {
  var modal = document.getElementById('addBlockerModal');
  if (modal) modal.remove();
  var resp = await fetch('/api/issue/' + issueId + '/dependencies', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({depends_on: dependsOnId}),
  });
  if (!resp.ok) { var err = await resp.json(); showToast('Error: ' + (err.error || 'Add failed'), 'error'); return; }
  showToast('Dependency added', 'success');
  await fetchData();
  if (selectedIssue === issueId) openDetail(issueId);
}

async function addComment(issueId) {
  var input = document.getElementById('commentInput');
  var text = input ? input.value.trim() : '';
  if (!text) return;
  var resp = await fetch('/api/issue/' + issueId + '/comments', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text: text}),
  });
  if (resp.ok) { input.value = ''; openDetail(issueId); }
}

async function loadTransitions(issueId) {
  try {
    var resp = await fetch('/api/issue/' + issueId + '/transitions');
    if (resp.ok) return await resp.json();
  } catch (e) {}
  return [];
}

// ---------------------------------------------------------------------------
// Metrics view
// ---------------------------------------------------------------------------
async function loadMetrics() {
  var days = document.getElementById('metricsDays').value;
  var container = document.getElementById('metricsContent');
  container.innerHTML = '<div class="text-slate-500">Loading...</div>';
  try {
    var resp = await fetch('/api/metrics?days=' + days);
    var m = await resp.json();
    var byTypeHtml = Object.keys(m.by_type || {}).map(function(t) {
      var d = m.by_type[t];
      return '<tr><td class="py-1 pr-4 text-slate-300">' + escHtml(t) + '</td>' +
        '<td class="py-1 pr-4">' + (d.avg_cycle_time_hours !== null ? d.avg_cycle_time_hours + 'h' : '\u2014') + '</td>' +
        '<td class="py-1">' + d.count + '</td></tr>';
    }).join('');

    container.innerHTML =
      '<div class="grid grid-cols-3 gap-4 mb-6">' +
        '<div class="bg-slate-800 rounded p-4 border border-slate-700">' +
          '<div class="text-slate-500 text-xs mb-1">Throughput</div>' +
          '<div class="text-2xl font-bold text-blue-400">' + m.throughput + '</div>' +
          '<div class="text-xs text-slate-500">issues closed</div></div>' +
        '<div class="bg-slate-800 rounded p-4 border border-slate-700">' +
          '<div class="text-slate-500 text-xs mb-1">Avg Cycle Time</div>' +
          '<div class="text-2xl font-bold text-emerald-400">' + (m.avg_cycle_time_hours !== null ? m.avg_cycle_time_hours + 'h' : '\u2014') + '</div>' +
          '<div class="text-xs text-slate-500">first WIP to done</div></div>' +
        '<div class="bg-slate-800 rounded p-4 border border-slate-700">' +
          '<div class="text-slate-500 text-xs mb-1">Avg Lead Time</div>' +
          '<div class="text-2xl font-bold text-amber-400">' + (m.avg_lead_time_hours !== null ? m.avg_lead_time_hours + 'h' : '\u2014') + '</div>' +
          '<div class="text-xs text-slate-500">creation to done</div></div>' +
      '</div>' +
      (byTypeHtml
        ? '<div class="bg-slate-800 rounded p-4 border border-slate-700">' +
          '<div class="text-xs font-medium text-slate-400 mb-2">By Type</div>' +
          '<table class="text-xs w-full"><thead><tr class="text-slate-500">' +
            '<th class="text-left py-1 pr-4">Type</th><th class="text-left py-1 pr-4">Avg Cycle</th><th class="text-left py-1">Count</th>' +
          '</tr></thead><tbody>' + byTypeHtml + '</tbody></table></div>'
        : '<div class="text-slate-500">No completed issues in this period.</div>');

    // Agent workload
    var agentLoad = {};
    allIssues.forEach(function(i) {
      if (i.assignee && (i.status_category || 'open') === 'wip') {
        agentLoad[i.assignee] = (agentLoad[i.assignee] || 0) + 1;
      }
    });
    var agents = Object.keys(agentLoad).sort(function(a, b) { return agentLoad[b] - agentLoad[a]; });
    if (agents.length) {
      var maxLoad = Math.max.apply(null, agents.map(function(a) { return agentLoad[a]; }));
      var agentHtml = agents.map(function(a) {
        var pct = (agentLoad[a] / maxLoad * 100);
        return '<div class="flex items-center gap-2 mb-1">' +
          '<span class="text-xs text-slate-300 w-24 truncate">' + escHtml(a) + '</span>' +
          '<div class="flex-1 h-4 bg-slate-900 rounded overflow-hidden">' +
            '<div class="h-full bg-blue-600 rounded" style="width:' + pct + '%"></div>' +
          '</div>' +
          '<span class="text-xs text-slate-400 w-6 text-right">' + agentLoad[a] + '</span></div>';
      }).join('');
      container.innerHTML += '<div class="bg-slate-800 rounded p-4 border border-slate-700 mt-4">' +
        '<div class="text-xs font-medium text-slate-400 mb-2">Agent Workload (Active WIP)</div>' +
        agentHtml + '</div>';
    }
  } catch (e) {
    container.innerHTML = '<div class="text-red-400">Failed to load metrics.</div>';
  }
}

// ---------------------------------------------------------------------------
// Activity feed
// ---------------------------------------------------------------------------
async function loadActivity() {
  var container = document.getElementById('activityContent');
  container.innerHTML = '<div class="text-slate-500">Loading...</div>';
  try {
    var resp = await fetch('/api/activity?limit=50');
    var events = await resp.json();
    if (!events.length) { container.innerHTML = '<div class="text-slate-500">No recent activity.</div>'; return; }
    container.innerHTML = events.map(function(e) {
      var time = e.created_at ? e.created_at.slice(5, 16) : '';
      var title = e.issue_title ? escHtml(e.issue_title.slice(0, 50)) : e.issue_id;
      var detail = '';
      if (e.event_type === 'status_changed') detail = e.old_value + ' \u2192 ' + e.new_value;
      else if (e.new_value) detail = e.new_value;
      return '<div class="flex items-start gap-3 py-2 border-b border-slate-800 cursor-pointer hover:bg-slate-800/50" onclick="openDetail(\'' + e.issue_id + '\')">' +
        '<span class="text-slate-600 shrink-0 w-24">' + time + '</span>' +
        '<span class="text-slate-400 shrink-0 w-32">' + escHtml(e.event_type) + '</span>' +
        '<span class="text-slate-300 truncate">' + title + '</span>' +
        (detail ? '<span class="text-slate-500 shrink-0">' + escHtml(detail) + '</span>' : '') +
        (e.actor ? '<span class="text-slate-600 shrink-0">' + escHtml(e.actor) + '</span>' : '') +
      '</div>';
    }).join('');
  } catch (e) {
    container.innerHTML = '<div class="text-red-400">Failed to load activity.</div>';
  }
}

// ---------------------------------------------------------------------------
// Server-side search
// ---------------------------------------------------------------------------
var _searchTimeout = null;
function debouncedSearch() {
  clearTimeout(_searchTimeout);
  _searchTimeout = setTimeout(doSearch, 200);
}

var searchResults = null;
async function doSearch() {
  var q = document.getElementById('filterSearch').value.trim();
  if (!q) { searchResults = null; render(); return; }
  try {
    var resp = await fetch('/api/search?q=' + encodeURIComponent(q) + '&limit=100');
    var data = await resp.json();
    searchResults = new Set(data.results.map(function(i) { return i.id; }));
  } catch (e) { searchResults = null; }
  render();
}

// ---------------------------------------------------------------------------
// Auto-refresh with change highlighting
// ---------------------------------------------------------------------------
var previousIssueState = {};
var changedIds = new Set();
var REFRESH_INTERVAL = 15000; // 15 seconds

function trackChanges(newIssues) {
  changedIds.clear();
  newIssues.forEach(function(i) {
    var prev = previousIssueState[i.id];
    if (prev && (prev.status !== i.status || prev.priority !== i.priority || prev.assignee !== i.assignee || prev.updated_at !== i.updated_at)) {
      changedIds.add(i.id);
    }
  });
  previousIssueState = {};
  newIssues.forEach(function(i) { previousIssueState[i.id] = {status: i.status, priority: i.priority, assignee: i.assignee, updated_at: i.updated_at}; });
}

// ---------------------------------------------------------------------------
// Critical path overlay
// ---------------------------------------------------------------------------
var criticalPathIds = new Set();
var criticalPathActive = false;

async function toggleCriticalPath() {
  criticalPathActive = !criticalPathActive;
  var btn = document.getElementById('btnCritPath');
  if (criticalPathActive) {
    btn.className = 'px-2 py-0.5 rounded bg-red-600 text-white';
    var resp = await fetch('/api/critical-path');
    var data = await resp.json();
    criticalPathIds = new Set(data.path.map(function(p) { return p.id; }));
  } else {
    btn.className = 'px-2 py-0.5 rounded bg-slate-700 hover:bg-slate-600';
    criticalPathIds.clear();
  }
  renderGraph();
}

// ---------------------------------------------------------------------------
// Impact scores (cascade analysis)
// ---------------------------------------------------------------------------
var impactScores = {};
function computeImpactScores() {
  var forward = {};
  allDeps.forEach(function(d) {
    if (!forward[d.to]) forward[d.to] = [];
    forward[d.to].push(d.from);
  });
  impactScores = {};
  allIssues.forEach(function(i) {
    var visited = new Set();
    var queue = [i.id];
    while (queue.length) {
      var cur = queue.shift();
      (forward[cur] || []).forEach(function(next) {
        if (!visited.has(next)) { visited.add(next); queue.push(next); }
      });
    }
    impactScores[i.id] = visited.size;
  });
}

function computeHealthScore() {
  if (!allIssues.length) return;
  var openIssues = allIssues.filter(function(i) { return (i.status_category || 'open') !== 'done'; });
  var blockedCount = openIssues.filter(function(i) {
    return (i.blocked_by || []).some(function(bid) {
      var b = issueMap[bid]; return b && (b.status_category || 'open') !== 'done';
    });
  }).length;
  var blockedRatio = openIssues.length ? blockedCount / openIssues.length : 0;
  var blockedScore = Math.round(25 * (1 - blockedRatio));
  var wipIssues = allIssues.filter(function(i) { return (i.status_category || 'open') === 'wip'; });
  var staleWip = wipIssues.filter(function(i) {
    return i.updated_at && (Date.now() - new Date(i.updated_at).getTime()) > 24 * 3600000;
  }).length;
  var freshScore = wipIssues.length ? Math.round(25 * (1 - staleWip / wipIssues.length)) : 25;
  var readyCount = allIssues.filter(function(i) { return i.is_ready; }).length;
  var readyScore = openIssues.length ? Math.min(25, Math.round(25 * readyCount / Math.max(openIssues.length * 0.3, 1))) : 25;
  var agentWip = {};
  wipIssues.forEach(function(i) { if (i.assignee) agentWip[i.assignee] = (agentWip[i.assignee] || 0) + 1; });
  var vals = Object.values(agentWip);
  var maxWip = vals.length ? Math.max.apply(null, vals) : 0;
  var balanceScore = maxWip > 5 ? 10 : maxWip > 3 ? 18 : 25;
  var score = blockedScore + freshScore + readyScore + balanceScore;
  var badge = document.getElementById('healthBadge');
  if (!badge) return;
  badge.textContent = score;
  badge.title = 'Health: ' + score + '/100';
  if (score >= 75) badge.className = 'cursor-pointer px-2 py-0.5 rounded text-xs font-bold bg-emerald-900/50 text-emerald-400 border border-emerald-700';
  else if (score >= 50) badge.className = 'cursor-pointer px-2 py-0.5 rounded text-xs font-bold bg-amber-900/50 text-amber-400 border border-amber-700';
  else badge.className = 'cursor-pointer px-2 py-0.5 rounded text-xs font-bold bg-red-900/50 text-red-400 border border-red-700';
  window._healthBreakdown = {
    score: score,
    blocked: { score: blockedScore, max: 25, detail: blockedCount + ' blocked of ' + openIssues.length + ' open' },
    freshness: { score: freshScore, max: 25, detail: staleWip + ' stale WIP of ' + wipIssues.length },
    ready: { score: readyScore, max: 25, detail: readyCount + ' ready issues' },
    balance: { score: balanceScore, max: 25, detail: 'Max agent WIP: ' + maxWip },
  };
}

function showHealthBreakdown() {
  var b = window._healthBreakdown;
  if (!b) return;
  var panel = document.getElementById('detailContent');
  var dp = document.getElementById('detailPanel');
  dp.classList.remove('translate-x-full');
  selectedIssue = null;
  panel.innerHTML =
    '<div class="flex items-center justify-between mb-3">' +
      '<span class="text-base font-semibold text-slate-200">System Health: ' + b.score + '/100</span>' +
      '<button onclick="closeDetail()" class="text-slate-500 hover:text-slate-300 text-lg">&times;</button></div>' +
    ['blocked', 'freshness', 'ready', 'balance'].map(function(k) {
      var f = b[k];
      var pct = Math.round(f.score / f.max * 100);
      return '<div class="mb-3"><div class="flex justify-between text-xs mb-1">' +
        '<span class="text-slate-300 capitalize">' + k + '</span>' +
        '<span class="text-slate-400">' + f.score + '/' + f.max + '</span></div>' +
        '<div class="w-full h-2 rounded-full bg-slate-900 overflow-hidden">' +
          '<div class="h-full rounded-full ' + (pct >= 75 ? 'bg-emerald-500' : pct >= 50 ? 'bg-amber-500' : 'bg-red-500') +
          '" style="width:' + pct + '%"></div></div>' +
        '<div class="text-xs text-slate-500 mt-0.5">' + f.detail + '</div></div>';
    }).join('');
}

// ---------------------------------------------------------------------------
// Plan/milestone tree view
// ---------------------------------------------------------------------------
async function loadPlanView(milestoneId) {
  var panel = document.getElementById('detailContent');
  panel.innerHTML = '<div class="text-slate-500 text-xs">Loading plan...</div>';
  try {
    var resp = await fetch('/api/plan/' + milestoneId);
    if (!resp.ok) { panel.innerHTML = '<div class="text-red-400 text-xs">No plan found for this issue.</div>'; return; }
    var plan = await resp.json();
    var m = plan.milestone || {};
    var phases = plan.phases || [];
    var totalSteps = plan.total_steps || 0;
    var completedSteps = plan.completed_steps || 0;
    var pct = totalSteps ? Math.round(completedSteps / totalSteps * 100) : 0;

    var html = '<div class="flex items-center justify-between mb-3">' +
      '<span class="text-xs text-slate-500">' + escHtml(m.id || milestoneId) + '</span>' +
      '<button onclick="openDetail(\'' + milestoneId + '\')" class="text-xs text-blue-400 hover:underline">Back to detail</button></div>' +
      '<div class="text-lg font-semibold text-slate-100 mb-2">' + escHtml(m.title || 'Plan') + '</div>' +
      '<div class="w-full h-3 rounded-full bg-slate-900 mb-1 overflow-hidden">' +
        '<div class="h-full bg-emerald-500 rounded-full" style="width:' + pct + '%"></div></div>' +
      '<div class="text-xs text-slate-500 mb-4">' + completedSteps + '/' + totalSteps + ' steps (' + pct + '%)</div>';

    phases.forEach(function(p) {
      var phase = p.phase || {};
      var steps = p.steps || [];
      var pDone = steps.filter(function(s) { return (s.status_category || 'open') === 'done'; }).length;
      var pPct = steps.length ? Math.round(pDone / steps.length * 100) : 0;
      html += '<div class="mb-3 bg-slate-800 rounded border border-slate-700 p-3">' +
        '<div class="flex items-center justify-between mb-1">' +
          '<span class="text-xs font-medium text-slate-300">' + escHtml(phase.title || 'Phase') + '</span>' +
          '<span class="text-xs text-slate-500">' + pDone + '/' + steps.length + '</span></div>' +
        '<div class="w-full h-1.5 rounded-full bg-slate-900 mb-2 overflow-hidden">' +
          '<div class="h-full bg-blue-500 rounded-full" style="width:' + pPct + '%"></div></div>' +
        steps.map(function(s) {
          var catColor = CATEGORY_COLORS[s.status_category || 'open'] || '#64748B';
          return '<div class="flex items-center gap-2 py-1 ml-4 cursor-pointer hover:text-blue-400" onclick="openDetail(\'' + s.id + '\')">' +
            '<span class="w-2 h-2 rounded-full shrink-0" style="background:' + catColor + '"></span>' +
            '<span class="text-xs text-slate-300">' + escHtml(s.title) + '</span>' +
            '<span class="text-xs text-slate-600">' + s.status + '</span></div>';
        }).join('') +
      '</div>';
    });

    panel.innerHTML = html;
  } catch (e) {
    panel.innerHTML = '<div class="text-red-400 text-xs">Failed to load plan.</div>';
  }
}

// Workflow state machine visualization
async function loadWorkflow() {
  var wfSelect = document.getElementById('workflowType');
  // Populate type dropdown if not done
  if (wfSelect && wfSelect.options.length <= 1) {
    var types = {}; allIssues.forEach(function(i) { types[i.type] = true; });
    Object.keys(types).sort().forEach(function(t) {
      var opt = document.createElement('option'); opt.value = t; opt.textContent = t;
      wfSelect.appendChild(opt);
    });
  }
  var typeName = wfSelect ? wfSelect.value : '';
  if (!typeName) return;
  try {
    var resp = await fetch('/api/type/' + typeName);
    if (!resp.ok) return;
    var tpl = await resp.json();
    var stateCounts = {};
    allIssues.filter(function(i) { return i.type === typeName; }).forEach(function(i) {
      stateCounts[i.status] = (stateCounts[i.status] || 0) + 1;
    });
    renderWorkflowGraph(tpl, stateCounts);
  } catch (e) {}
}

function renderWorkflowGraph(template, stateCounts) {
  var container = document.getElementById('workflowCy');
  var nodes = template.states.map(function(s) {
    var count = stateCounts[s.name] || 0;
    return { data: { id: s.name, label: s.name + (count ? ' (' + count + ')' : ''), category: s.category, count: count } };
  });
  var edges = template.transitions.map(function(t, i) {
    return { data: { id: 'wt' + i, source: t.from, target: t.to, enforcement: t.enforcement } };
  });
  if (window._workflowCy) window._workflowCy.destroy();
  window._workflowCy = cytoscape({
    container: container,
    elements: nodes.concat(edges),
    layout: { name: 'dagre', rankDir: 'LR', rankSep: 100, nodeSep: 60, padding: 30 },
    style: [
      { selector: 'node', style: {
        'label': 'data(label)', 'font-size': '12px', 'font-family': 'JetBrains Mono, monospace',
        'text-valign': 'center', 'text-halign': 'center', 'color': '#F1F5F9',
        'text-outline-color': '#0F172A', 'text-outline-width': 2,
        'width': 80, 'height': 40, 'shape': 'round-rectangle',
        'background-color': function(ele) { return CATEGORY_COLORS[ele.data('category')] || '#64748B'; },
      }},
      { selector: 'edge', style: {
        'width': 2, 'line-color': '#475569', 'target-arrow-color': '#475569',
        'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'arrow-scale': 0.8,
        'label': 'data(enforcement)', 'font-size': '9px', 'color': '#94A3B8',
        'text-rotation': 'autorotate', 'text-margin-y': -10,
      }},
    ],
    minZoom: 0.3, maxZoom: 3,
  });
  window._workflowCy.fit(undefined, 40);
}

// ---------------------------------------------------------------------------
// Batch operations
// ---------------------------------------------------------------------------
function updateBatchBar() {
  var bar = document.getElementById('batchBar');
  if (!bar) return;
  if (selectedCards.size > 0) {
    bar.classList.remove('hidden');
    document.getElementById('batchCount').textContent = selectedCards.size + ' selected';
  } else {
    bar.classList.add('hidden');
  }
}

async function batchSetPriority() {
  var existing = document.getElementById('batchPrioModal');
  if (existing) existing.remove();
  var modal = document.createElement('div');
  modal.id = 'batchPrioModal';
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = '<div class="bg-slate-800 rounded-lg border border-slate-600 p-4 w-72 shadow-xl">' +
    '<div class="text-sm text-slate-200 mb-2">Set priority for ' + selectedCards.size + ' issues</div>' +
    '<select id="batchPrioSelect" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-2 py-2 border border-slate-600 mb-3">' +
      '<option value="0">P0  Critical</option><option value="1">P1  High</option>' +
      '<option value="2" selected>P2  Medium</option><option value="3">P3  Low</option><option value="4">P4  Backlog</option>' +
    '</select>' +
    '<div class="flex justify-end gap-2">' +
      '<button id="batchPrioCancel" class="text-xs bg-slate-700 px-3 py-1.5 rounded hover:bg-slate-600">Cancel</button>' +
      '<button id="batchPrioConfirm" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700">Apply</button>' +
    '</div></div>';
  document.body.appendChild(modal);
  document.getElementById('batchPrioCancel').onclick = function() { modal.remove(); };
  modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
  document.getElementById('batchPrioConfirm').onclick = async function() {
    var prio = parseInt(document.getElementById('batchPrioSelect').value);
    modal.remove();
    await fetch('/api/batch/update', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({issue_ids: Array.from(selectedCards), priority: prio}),
    });
    selectedCards.clear();
    multiSelectMode = false;
    showToast('Priority updated', 'success');
    await fetchData();
  };
}

async function batchCloseSelected() {
  var existing = document.getElementById('batchCloseModal');
  if (existing) existing.remove();
  var count = selectedCards.size;
  var modal = document.createElement('div');
  modal.id = 'batchCloseModal';
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = '<div class="bg-slate-800 rounded-lg border border-slate-600 p-4 w-72 shadow-xl">' +
    '<div class="text-sm text-slate-200 mb-3">Close ' + count + ' issue' + (count !== 1 ? 's' : '') + '?</div>' +
    '<div class="flex justify-end gap-2">' +
      '<button id="batchCloseCancel" class="text-xs bg-slate-700 px-3 py-1.5 rounded hover:bg-slate-600">Cancel</button>' +
      '<button id="batchCloseConfirm" class="text-xs bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700">Close All</button>' +
    '</div></div>';
  document.body.appendChild(modal);
  document.getElementById('batchCloseCancel').onclick = function() { modal.remove(); };
  modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
  document.getElementById('batchCloseConfirm').onclick = async function() {
    modal.remove();
    await fetch('/api/batch/close', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({issue_ids: Array.from(selectedCards)}),
    });
    selectedCards.clear();
    multiSelectMode = false;
    showToast(count + ' issue' + (count !== 1 ? 's' : '') + ' closed', 'success');
    await fetchData();
  };
}

async function showCreateForm() {
  var existing = document.getElementById('createModal');
  if (existing) existing.remove();
  var types = [];
  try { var tr = await fetch('/api/types'); types = await tr.json(); } catch(e) {}
  var typeOpts = types.map(function(t) {
    return '<option value="' + t.type + '"' + (t.type === 'task' ? ' selected' : '') + '>' + t.display_name + '</option>';
  }).join('');
  var modal = document.createElement('div');
  modal.id = 'createModal';
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = '<div class="bg-slate-800 rounded-lg border border-slate-600 p-5 w-96 shadow-xl max-h-[80vh] overflow-y-auto">' +
    '<div class="text-sm font-semibold text-slate-200 mb-3">Create Issue</div>' +
    '<div class="flex flex-col gap-3">' +
      '<div><label for="createTitle" class="text-xs text-slate-400">Title *</label>' +
        '<input id="createTitle" type="text" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-3 py-2 border border-slate-600 mt-1 focus:outline-none focus:border-blue-500"></div>' +
      '<div class="flex gap-2">' +
        '<div class="flex-1"><label for="createType" class="text-xs text-slate-400">Type</label>' +
          '<select id="createType" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-2 py-2 border border-slate-600 mt-1">' + typeOpts + '</select></div>' +
        '<div class="w-20"><label for="createPriority" class="text-xs text-slate-400">Priority</label>' +
          '<select id="createPriority" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-2 py-2 border border-slate-600 mt-1">' +
            '<option value="0">P0</option><option value="1">P1</option><option value="2" selected>P2</option><option value="3">P3</option><option value="4">P4</option>' +
          '</select></div></div>' +
      '<div><label for="createDesc" class="text-xs text-slate-400">Description</label>' +
        '<textarea id="createDesc" rows="3" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-3 py-2 border border-slate-600 mt-1 focus:outline-none focus:border-blue-500 resize-none"></textarea></div>' +
      '<div><label for="createAssignee" class="text-xs text-slate-400">Assignee</label>' +
        '<input id="createAssignee" type="text" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-3 py-2 border border-slate-600 mt-1 focus:outline-none focus:border-blue-500"></div>' +
      '<div><label for="createLabels" class="text-xs text-slate-400">Labels (comma-separated)</label>' +
        '<input id="createLabels" type="text" class="w-full bg-slate-700 text-slate-200 text-xs rounded px-3 py-2 border border-slate-600 mt-1 focus:outline-none focus:border-blue-500"></div>' +
    '</div>' +
    '<div class="flex justify-end gap-2 mt-4">' +
      '<button onclick="document.getElementById(\'createModal\').remove()" class="text-xs bg-slate-700 px-3 py-1.5 rounded hover:bg-slate-600">Cancel</button>' +
      '<button onclick="submitCreateForm()" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700">Create</button>' +
    '</div></div>';
  document.body.appendChild(modal);
  modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
  document.getElementById('createTitle').focus();
}

async function submitCreateForm() {
  var title = document.getElementById('createTitle').value.trim();
  if (!title) { showToast('Title is required', 'error'); return; }
  var labelsRaw = document.getElementById('createLabels').value.trim();
  var labels = labelsRaw ? labelsRaw.split(',').map(function(l) { return l.trim(); }).filter(Boolean) : null;
  var body = {
    title: title,
    type: document.getElementById('createType').value,
    priority: parseInt(document.getElementById('createPriority').value),
    description: document.getElementById('createDesc').value.trim(),
    assignee: document.getElementById('createAssignee').value.trim(),
  };
  if (labels && labels.length) body.labels = labels;
  try {
    var resp = await fetch('/api/issues', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body),
    });
    if (!resp.ok) { var err = await resp.json(); showToast('Error: ' + (err.error || 'Create failed'), 'error'); return; }
    var created = await resp.json();
    document.getElementById('createModal').remove();
    showToast('Created ' + created.id, 'success');
    await fetchData();
    openDetail(created.id);
  } catch (e) { showToast('Network error', 'error'); }
}

// ---------------------------------------------------------------------------
// Focus management
// ---------------------------------------------------------------------------
function trapFocus(panel) {
  var focusable = panel.querySelectorAll('button, input, select, [tabindex]');
  if (focusable.length) focusable[0].focus();
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
parseHash();
fetchData().then(function() {
  switchView(currentView);
  if (kanbanMode === 'cluster') switchKanbanMode('cluster');
  else switchKanbanMode('standard');
  if (selectedIssue) openDetail(selectedIssue);
});
setInterval(function() { if (!document.hidden) fetchData(); }, REFRESH_INTERVAL);
</script>
</body>
</html>
