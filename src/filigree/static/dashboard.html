<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filigree Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<style>
  :root {
    --surface-base: #0B1215;
    --surface-raised: #131E24;
    --surface-overlay: #1A2B34;
    --surface-hover: #243A45;
    --border-default: #1E3340;
    --border-strong: #2A4454;
    --text-primary: #E2EEF2;
    --text-secondary: #8FAAB8;
    --text-muted: #5A7D8C;
    --accent: #38BDF8;
    --accent-hover: #0EA5E9;
    --accent-subtle: rgba(12,74,110,0.2);
    --scrollbar-track: #131E24;
    --scrollbar-thumb: #2A4454;
    --graph-text: #E2EEF2;
    --graph-outline: #0B1215;
    --graph-edge: #2A4454;
    --status-open: #64748B;
    --status-wip: #38BDF8;
    --status-done: #7B919C;
  }
  [data-theme="light"] {
    --surface-base: #F0F6F8;
    --surface-raised: #FFFFFF;
    --surface-overlay: #E8F1F4;
    --surface-hover: #DCE9EE;
    --border-default: #C5D8E0;
    --border-strong: #9BBBC8;
    --text-primary: #0F2027;
    --text-secondary: #3D6070;
    --text-muted: #6B8D9C;
    --accent: #0284C7;
    --accent-hover: #0369A1;
    --accent-subtle: rgba(2,132,199,0.2);
    --scrollbar-track: #E8F1F4;
    --scrollbar-thumb: #B0C9D2;
    --graph-text: #0F2027;
    --graph-outline: #F0F6F8;
    --graph-edge: #9BBBC8;
    --status-open: #64748B;
    --status-wip: #0284C7;
    --status-done: #7B919C;
  }
  .bg-base { background: var(--surface-base); }
  .bg-raised { background: var(--surface-raised); }
  .bg-overlay { background: var(--surface-overlay); }
  .bg-hover { background: var(--surface-hover); }
  .border-default { border-color: var(--border-default); }
  .border-strong { border-color: var(--border-strong); }
  .text-primary { color: var(--text-primary); }
  .text-secondary { color: var(--text-secondary); }
  .text-muted { color: var(--text-muted); }
  .bg-accent { background: var(--accent); }
  .bg-accent-hover:hover { background: var(--accent-hover); }
  .text-accent { color: var(--accent); }
  .bg-overlay-hover:hover { background: var(--surface-hover); }
  .text-primary-hover:hover { color: var(--text-primary); }
  .text-secondary-hover:hover { color: var(--text-secondary); }
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');
  body { font-family: 'JetBrains Mono', 'Fira Code', monospace; background: var(--surface-base); color: var(--text-primary); }
  #cy { width: 100%; height: 100%; }
  #cy, #workflowCy { background: var(--surface-base); }
  .card { transition: all 0.15s ease; }
  .card:hover { background: var(--surface-hover) !important; }
  .card:focus { outline: 2px solid var(--accent); outline-offset: -2px; }
  .ready-border { border-left: 4px solid #10B981; }
  .scrollbar-thin::-webkit-scrollbar { width: 6px; }
  .scrollbar-thin::-webkit-scrollbar-track { background: var(--scrollbar-track); }
  .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
  .detail-panel { transition: transform 0.2s ease; }
  .kanban-col { min-width: 280px; flex: 1 1 0; }
  .kanban-col.drag-valid { outline: 2px dashed var(--accent); outline-offset: -2px; background: var(--accent-subtle); }
  .kanban-col.drag-invalid { opacity: 0.3; cursor: not-allowed; }
  .card[draggable="true"] { cursor: grab; }
  .card[draggable="true"]:active { cursor: grabbing; }
  #refreshIndicator { transition: opacity 0.3s ease; }
  @keyframes stale-pulse { 0%,100% { border-left-color: #EF4444; } 50% { border-left-color: #7F1D1D; } }
  .aging-border { border-left: 4px solid #F59E0B; }
  .stale-border { border-left: 4px solid #EF4444; animation: stale-pulse 2s infinite; }
  .changed-flash { animation: flash 1s ease-out; }
  @keyframes flash { 0% { box-shadow: 0 0 8px rgba(56,189,248,0.5); } 100% { box-shadow: none; } }
  .popover { position: absolute; z-index: 60; max-width: 320px; }
  .help-icon { display: inline-flex; align-items: center; justify-content: center;
    width: 16px; height: 16px; border-radius: 50%; font-size: 10px; line-height: 1;
    cursor: pointer; vertical-align: middle; margin-left: 4px; flex-shrink: 0; }
  .tour-highlight { outline: 3px solid var(--accent) !important; outline-offset: 4px; position: relative; z-index: 55; }
  .tour-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; }
  .tour-tooltip { position: fixed; z-index: 56; max-width: 360px; }
  button, select, input[type="text"], input[type="checkbox"] { min-height: 36px; }
  @media (pointer: coarse) { button, select, input[type="text"] { min-height: 44px; min-width: 44px; } }
  .graph-toolbar label { min-height: 44px; display: inline-flex; align-items: center; }
  .graph-toolbar button, .graph-toolbar select, .graph-toolbar input[type="text"], .graph-toolbar summary {
    min-height: 44px;
  }
  button:focus-visible, select:focus-visible, input:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
  .focus-accent:focus { border-color: var(--accent); }
  .btn-loading { opacity: 0.6; pointer-events: none; }
  @media (max-width: 768px) {
    .kanban-col { min-width: 100% !important; }
    #detailPanel { width: 100% !important; }
    header { flex-wrap: wrap; gap: 0.5rem; }
    header > div:nth-child(2) { flex-wrap: wrap; }
    footer { flex-wrap: wrap; }
  }
  @media (min-width: 769px) and (max-width: 1200px) {
    #detailPanel { width: 450px !important; }
    .kanban-col { min-width: 260px; }
  }
</style>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { mono: ['JetBrains Mono', 'Fira Code', 'monospace'] },
    }
  }
}
</script>
</head>
<body class="bg-base h-screen flex flex-col overflow-hidden text-sm">
<a href="#kanbanBoard" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-accent focus:text-white focus:px-3 focus:py-1 focus:rounded focus:z-50">Skip to content</a>

<!-- Top Nav -->
<header class="flex items-center justify-between px-4 py-2 bg-raised border-b border-default shrink-0">
  <div class="flex items-center gap-4">
    <span class="text-base font-semibold text-accent">&#9670; Filigree</span>
    <div id="projectSwitcherWrap" style="display:none">
      <select id="projectSwitcher" onchange="setProject(this.value)"
        class="bg-overlay text-primary text-xs rounded px-2 py-1 border border-strong"
        aria-label="Switch project">
      </select>
    </div>
    <button onclick="showCreateForm()" class="text-xs bg-accent text-white px-2 py-1 rounded bg-accent-hover" title="Create Issue">+ New</button>
    <div class="flex gap-1">
      <button id="btnGraph" onclick="switchView('graph')" class="px-3 py-1 rounded text-xs font-medium" title="Dependency graph visualization">Graph</button>
      <button id="btnKanban" onclick="switchView('kanban')" class="px-3 py-1 rounded text-xs font-medium" title="Kanban board view">Kanban</button>
      <button id="btnMetrics" onclick="switchView('metrics')" class="px-3 py-1 rounded text-xs font-medium" title="Flow metrics — throughput, cycle time, lead time">Metrics</button>
      <button id="btnActivity" onclick="switchView('activity')" class="px-3 py-1 rounded text-xs font-medium" title="Recent events across all issues">Activity</button>
      <button id="btnWorkflow" onclick="switchView('workflow')" class="px-3 py-1 rounded text-xs font-medium" title="Workflow state machine diagram">Workflow</button>
      <button id="btnFiles" onclick="switchView('files')" class="px-3 py-1 rounded text-xs font-medium" title="File records and scan findings">Files</button>
      <button id="btnHealth" onclick="switchView('health')" class="px-3 py-1 rounded text-xs font-medium" title="Code health — hotspots, severity breakdown, scan coverage">Health</button>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="flex items-center gap-3">
    <button id="btnReady" onclick="toggleReady()" class="px-2 py-1 rounded text-xs font-medium bg-emerald-900/50 text-emerald-400 border border-emerald-700" title="Toggle: sort ready (unblocked) issues first">
      &#9679; Ready (<span id="readyCount">0</span>)
    </button>
    <button onclick="showReadyHelp(this)" class="help-icon bg-overlay text-secondary text-primary-hover" title="What does Ready mean?" aria-label="Explain ready filter">?</button>
    <button id="btnBlocked" onclick="toggleBlocked()" class="px-2 py-1 rounded text-xs font-medium bg-overlay text-secondary border border-strong" title="Toggle: show only blocked issues">
      &#128279; Blocked (<span id="blockedCount">0</span>)
    </button>
    <button onclick="showBlockedHelp(this)" class="help-icon bg-overlay text-secondary text-primary-hover" title="What does Blocked mean?" aria-label="Explain blocked filter">?</button>
    <label for="filterPriority" class="text-xs text-secondary sr-only">Priority</label>
    <select id="filterPriority" onchange="applyFilters()" class="bg-overlay text-primary text-xs rounded px-2 py-1 border border-strong">
      <option value="all">Priority: All</option>
      <option value="0-1">P0-P1</option>
      <option value="2">P2</option>
      <option value="3-4">P3-P4</option>
    </select>
    <label for="filterSearch" class="text-xs text-secondary sr-only">Search</label>
    <div class="relative">
      <input id="filterSearch" type="text" placeholder="Search..." oninput="debouncedSearch()"
             class="bg-overlay text-primary text-xs rounded px-3 py-1 pr-6 border border-strong w-56 focus:outline-none focus-accent">
      <button id="searchClear" onclick="clearSearch()"
              class="hidden absolute right-1.5 top-1/2 -translate-y-1/2 text-muted text-primary-hover text-xs leading-none" title="Clear search" aria-label="Clear search">&times;</button>
    </div>
    <button onclick="toggleMultiSelect()" id="btnMultiSelect" class="px-2 py-1 rounded text-xs font-medium bg-overlay text-secondary border border-strong" title="Toggle multi-select mode for batch operations">Select</button>
    <div class="flex gap-1 text-xs">
      <label class="flex items-center gap-1 text-secondary"><input type="checkbox" id="filterOpen" checked onchange="applyFilters()" style="accent-color:var(--accent)"> Open</label>
      <label class="flex items-center gap-1 text-secondary"><input type="checkbox" id="filterInProgress" checked onchange="applyFilters()" style="accent-color:var(--accent)"> Active</label>
      <label class="flex items-center gap-1 text-secondary"><input type="checkbox" id="filterClosed" checked onchange="applyFilters()" style="accent-color:var(--accent)"> Closed</label>
    </div>
    <select id="filterPreset" onchange="loadPreset()" class="bg-overlay text-primary text-xs rounded px-2 py-1 border border-strong">
      <option value="">Presets...</option>
    </select>
    <button onclick="savePreset()" class="text-xs bg-overlay text-secondary px-2 py-1 rounded border border-strong bg-overlay-hover" title="Save current filters as preset">Save</button>
  </div>

  <div class="flex items-center gap-3 text-xs text-secondary">
    <span id="refreshIndicator" class="opacity-0 text-accent">Refreshing...</span>
    <span id="healthBadge" onclick="showHealthBreakdown()" class="cursor-pointer px-2 py-0.5 rounded text-xs font-bold" title="System Health Score — click for breakdown">--</span>
    <button onclick="showHealthHelp(this)" class="help-icon bg-overlay text-secondary text-primary-hover" title="What is Health Score?" aria-label="Explain health score">?</button>
    <div class="relative">
      <button onclick="toggleSettingsMenu(event)" id="settingsGear" class="text-xs px-2 py-1 rounded bg-overlay bg-overlay-hover" title="Settings" aria-label="Settings menu">&#9881;</button>
      <div id="settingsDropdown" class="hidden absolute right-0 top-full mt-1 rounded-lg shadow-xl text-xs z-50" style="background:var(--surface-base);border:1px solid var(--border-strong);min-width:160px">
        <button onclick="reloadServer()" class="w-full text-left px-3 py-2 bg-overlay-hover text-primary rounded-t-lg">&#8635; Reload server</button>
        <button onclick="toggleTheme();closeSettingsMenu()" id="themeToggle" class="w-full text-left px-3 py-2 bg-overlay-hover text-primary rounded-b-lg">&#9788; Toggle theme</button>
      </div>
    </div>
  </div>
</header>

<!-- Main content area -->
<div class="flex flex-1 overflow-hidden relative">
  <!-- Graph view -->
  <div id="graphView" class="flex-1 hidden flex flex-col">
    <div class="graph-toolbar flex flex-wrap items-center gap-2 px-4 py-1 bg-raised text-xs text-secondary border-b border-default overflow-x-auto">
      <div class="flex items-center gap-2 shrink-0">
        <label for="graphPreset" class="text-xs text-secondary">Preset:</label>
        <select id="graphPreset" onchange="setGraphPreset(this.value)" class="bg-overlay text-primary text-xs rounded px-2 py-0.5 border border-strong">
          <option value="execution" selected>Execution</option>
          <option value="roadmap">Roadmap</option>
        </select>
        <button onclick="graphFit()" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover" title="Reset zoom and center the graph">Fit</button>
        <button id="btnCritPath" onclick="toggleCriticalPath()" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover" title="Highlight the longest dependency chain">Critical Path</button>
        <button id="btnGraphLegend" onclick="toggleGraphLegend()" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover">Legend</button>
      </div>

      <details id="graphFiltersGroup" class="shrink-0">
        <summary class="cursor-pointer select-none px-2 py-0.5 rounded bg-overlay bg-overlay-hover border border-strong">
          Filters
        </summary>
        <div class="mt-1 flex flex-wrap items-center gap-2 rounded border border-strong bg-overlay/40 px-2 py-1">
          <label class="flex items-center gap-1">
            <input type="checkbox" id="graphEpicsOnly" onchange="onGraphEpicsOnlyChange()" style="accent-color:var(--accent)"> Epics only
          </label>
          <label class="flex items-center gap-1">
            <input type="checkbox" id="graphReadyOnly" onchange="renderGraph()" style="accent-color:var(--accent)"> Ready only
          </label>
          <label class="flex items-center gap-1">
            <input type="checkbox" id="graphBlockedOnly" onchange="renderGraph()" style="accent-color:var(--accent)"> Blocked only
          </label>
          <label class="flex items-center gap-1">
            Assignee:
            <input id="graphAssignee" type="text" placeholder="all" aria-label="Filter graph by assignee" oninput="onGraphAssigneeInput()"
                   class="bg-overlay text-primary text-xs rounded px-2 py-0.5 border border-strong w-28 focus:outline-none focus-accent">
          </label>
        </div>
      </details>

      <details id="graphAdvancedGroup" class="shrink-0">
        <summary class="cursor-pointer select-none px-2 py-0.5 rounded bg-overlay bg-overlay-hover border border-strong">
          Advanced
        </summary>
        <div class="mt-1 flex flex-wrap items-center gap-2 rounded border border-strong bg-overlay/40 px-2 py-1">
          <label class="flex items-center gap-1">
            <input type="checkbox" id="graphFocusMode" onchange="onGraphFocusModeChange()" style="accent-color:var(--accent)"> Focus
          </label>
          <label class="flex items-center gap-1">
            Root issue:
            <input id="graphFocusRoot" type="text" placeholder="issue id (auto-enables focus)" aria-label="Focus root issue ID" oninput="onGraphFocusRootInput()"
                   class="bg-overlay text-primary text-xs rounded px-2 py-0.5 border border-strong w-32 focus:outline-none focus-accent">
          </label>
          <label class="flex items-center gap-1">
            Radius:
            <select id="graphFocusRadius" onchange="renderGraph()" class="bg-overlay text-primary text-xs rounded px-1 py-0.5 border border-strong">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </label>
          <button id="graphClearFocusBtn" onclick="clearGraphFocus()" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover" title="Clear graph focus root/radius">Clear Focus</button>
          <span class="text-muted">|</span>
          <label class="flex items-center gap-1">
            Trace path:
            <input id="graphPathSource" type="text" placeholder="issue ID" aria-label="Path source issue ID" oninput="onGraphPathInput()" class="bg-overlay text-primary text-xs rounded px-2 py-0.5 border border-strong w-24 focus:outline-none focus-accent">
            <select id="graphPathDirection" aria-label="Path traversal direction" class="bg-overlay text-primary text-xs rounded px-1 py-0.5 border border-strong" title="Path direction">
              <option value="upstream" selected>upstream</option>
              <option value="downstream">downstream</option>
            </select>
            <input id="graphPathTarget" type="text" placeholder="issue ID" aria-label="Path target issue ID" oninput="onGraphPathInput()" class="bg-overlay text-primary text-xs rounded px-2 py-0.5 border border-strong w-24 focus:outline-none focus-accent">
          </label>
          <button id="graphTraceBtn" onclick="traceGraphPath()" disabled class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover opacity-50 cursor-not-allowed" title="Trace dependency path between source and target">Trace</button>
          <button id="graphClearPathBtn" onclick="clearGraphPath()" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover" title="Clear active path trace">Clear Path</button>
          <span class="text-muted">|</span>
          <label class="flex items-center gap-1">
            Node cap:
            <select id="graphNodeLimit" onchange="renderGraph()" class="bg-overlay text-primary text-xs rounded px-1 py-0.5 border border-strong">
              <option value="300">300</option>
              <option value="600" selected>600</option>
              <option value="1200">1200</option>
            </select>
          </label>
          <label class="flex items-center gap-1">
            Edge cap:
            <select id="graphEdgeLimit" onchange="renderGraph()" class="bg-overlay text-primary text-xs rounded px-1 py-0.5 border border-strong">
              <option value="1000">1000</option>
              <option value="2000" selected>2000</option>
              <option value="4000">4000</option>
            </select>
          </label>
          <span class="text-muted">|</span>
          <button id="graphSearchPrevBtn" onclick="graphSearchPrev()" disabled aria-label="Previous search match" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover opacity-50 cursor-not-allowed" title="Previous graph search match">Prev match</button>
          <button id="graphSearchNextBtn" onclick="graphSearchNext()" disabled aria-label="Next search match" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover opacity-50 cursor-not-allowed" title="Next graph search match">Next match</button>
          <span id="graphSearchState" class="text-[11px] text-secondary">Search: n/a</span>
        </div>
      </details>

      <div id="graphNotice" role="status" aria-live="polite" class="hidden px-2 py-0.5 rounded border border-amber-700 text-amber-300 bg-amber-900/30"></div>
      <div id="graphFilterState" class="text-[11px] text-secondary"></div>
      <div id="graphPerfState" class="text-[11px] text-secondary"></div>
    </div>
    <div class="relative flex-1">
      <div id="cy" class="absolute inset-0"></div>
      <div id="graphLegend" class="hidden absolute top-2 right-4 bg-base border border-strong rounded-lg p-3 text-xs z-10 max-w-xs shadow-xl">
        <div class="text-primary font-medium mb-2">Graph Legend</div>
        <div class="text-secondary space-y-2">
          <div>
            <div class="font-medium text-primary mb-1">Node Shapes</div>
            <div class="grid grid-cols-2 gap-x-3 gap-y-0.5">
              <div>&#11043; Hexagon = Epic</div>
              <div>&#9670; Diamond = Bug</div>
              <div>&#9733; Star = Feature</div>
              <div>&#9645; Rectangle = Task</div>
            </div>
          </div>
          <div>
            <div class="font-medium text-primary mb-1">Colors</div>
            <div class="flex gap-3">
              <div><span class="inline-block w-3 h-3 rounded" style="background:var(--status-open)"></span> Open</div>
              <div><span class="inline-block w-3 h-3 rounded" style="background:var(--status-wip)"></span> In Progress</div>
              <div><span class="inline-block w-3 h-3 rounded" style="background:var(--status-done)"></span> Done</div>
            </div>
          </div>
          <div>
            <div class="font-medium text-primary mb-1">Indicators</div>
            <div>Green border = Ready (no blockers)</div>
            <div>Larger node = Higher priority</div>
            <div>Arrows = blocks &rarr; blocked</div>
          </div>
          <div>
            <div class="font-medium text-primary mb-1">Interactions</div>
            <div>Click node &rarr; Open detail panel</div>
            <div>Hover node &rarr; Highlight downstream</div>
          </div>
        </div>
        <button onclick="toggleGraphLegend()" class="text-muted text-primary-hover mt-2">Close</button>
      </div>
    </div>
  </div>

  <!-- Kanban view -->
  <div id="kanbanView" class="flex-1 hidden flex flex-col">
    <div class="flex items-center gap-2 px-4 py-1 bg-raised text-xs text-secondary border-b border-default">
      <button id="btnStandard" onclick="switchKanbanMode('standard')" class="px-2 py-0.5 rounded" title="Three columns: Open, In Progress, Done">Standard</button>
      <button id="btnCluster" onclick="switchKanbanMode('cluster')" class="px-2 py-0.5 rounded" title="Group issues by parent epic with progress bars">Cluster</button>
      <span class="text-muted">|</span>
      <select id="filterType" onchange="applyTypeFilter()" class="bg-overlay text-primary text-xs rounded px-2 py-0.5 border border-strong" title="Filter to one issue type and show its workflow states as columns">
        <option value="">All types</option>
      </select>
      <span id="typeFilterPill" class="hidden text-xs px-2 py-0.5 rounded border text-accent" style="background:var(--accent-subtle);border-color:var(--accent)">
        <span id="typeFilterLabel"></span>
        <button onclick="clearTypeFilter()" class="ml-1 text-accent hover:text-white" title="Clear type filter" aria-label="Clear type filter">&times;</button>
      </span>
      <span class="text-muted">|</span>
      <button id="btnKanbanLegend" onclick="toggleKanbanLegend()" class="px-2 py-0.5 rounded bg-overlay bg-overlay-hover">Legend</button>
    </div>
    <div id="kanbanLegend" class="hidden bg-base border-b border-strong px-4 py-2 text-xs">
      <div class="flex flex-wrap gap-x-6 gap-y-1 text-secondary">
        <span class="font-medium text-primary">Card Borders:</span>
        <span><span class="inline-block w-3 h-0.5 bg-emerald-500 mr-1 align-middle"></span>Ready (no blockers)</span>
        <span><span class="inline-block w-3 h-0.5 bg-amber-500 mr-1 align-middle"></span>Aging (WIP &gt;4h)</span>
        <span><span class="inline-block w-3 h-0.5 bg-red-500 mr-1 align-middle"></span>Stale (WIP &gt;24h)</span>
        <span class="font-medium text-primary ml-4">Badges:</span>
        <span><span class="text-red-400">&#128279;</span> Blocked by N</span>
        <span><span class="text-amber-400">&#9889;</span>N = Blocks N downstream</span>
        <span>&#128100; = Assignee</span>
        <span class="font-medium text-primary ml-4">Modes:</span>
        <span>Standard = Open / WIP / Done</span>
        <span>Cluster = Grouped by epic</span>
      </div>
    </div>
    <div class="flex gap-4 p-4 flex-1 overflow-x-auto" id="kanbanBoard" role="region" aria-label="Kanban Board"></div>
  </div>

  <!-- Metrics view -->
  <div id="metricsView" class="flex-1 hidden overflow-y-auto p-6">
    <div class="max-w-3xl mx-auto">
      <div class="flex items-center gap-3 mb-6">
        <span class="text-base font-semibold text-primary">Flow Metrics</span>
        <select id="metricsDays" onchange="loadMetrics()" class="bg-overlay text-xs rounded px-2 py-1 border border-strong">
          <option value="7">7 days</option>
          <option value="30" selected>30 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
      <div id="metricsContent" class="text-secondary text-xs">Loading...</div>
    </div>
  </div>

  <!-- Activity view -->
  <div id="activityView" class="flex-1 hidden overflow-y-auto p-6">
    <div class="max-w-3xl mx-auto">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-base font-semibold text-primary">Recent Activity</span>
        <button onclick="loadActivity()" class="text-xs bg-overlay px-2 py-1 rounded bg-overlay-hover">Refresh</button>
      </div>
      <div id="activityContent" class="text-secondary text-xs">Loading...</div>
    </div>
  </div>

  <!-- Workflow view -->
  <div id="workflowView" class="flex-1 hidden flex flex-col">
    <div class="flex items-center gap-2 px-4 py-1 bg-raised text-xs text-secondary border-b border-default">
      <label for="workflowType" class="text-xs text-secondary">Type:</label>
      <select id="workflowType" onchange="loadWorkflow()" class="bg-overlay text-primary text-xs rounded px-2 py-1 border border-strong">
        <option value="">Select type...</option>
      </select>
    </div>
    <div id="workflowCy" class="flex-1"></div>
  </div>

  <!-- Files view -->
  <div id="filesView" class="flex-1 hidden overflow-y-auto p-6">
    <div class="max-w-6xl mx-auto">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-base font-semibold text-primary">Files</span>
        <div class="flex items-center gap-2">
          <input id="filesSearch" type="text" placeholder="Filter by path..."
                 class="bg-overlay text-primary text-xs rounded px-3 py-1 border border-strong w-64 focus:outline-none focus-accent">
          <label class="flex items-center gap-1 text-xs text-secondary">
            <input type="checkbox" id="filesCriticalOnly" style="accent-color:var(--accent)"> Critical only
          </label>
        </div>
      </div>
      <div id="filesContent" class="text-secondary text-xs">Loading...</div>
    </div>
  </div>

  <!-- Code Health view -->
  <div id="healthView" class="flex-1 hidden overflow-y-auto p-6">
    <div class="max-w-5xl mx-auto">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-base font-semibold text-primary">Code Health</span>
      </div>
      <div id="healthContent" class="text-secondary text-xs">Loading...</div>
    </div>
  </div>

  <!-- Detail panel (slides in from right) -->
  <div id="detailPanel" role="complementary" aria-label="Issue Detail" class="detail-panel absolute top-0 right-0 h-full w-[500px] bg-raised border-l border-default flex flex-col transform translate-x-full z-10">
    <div id="detailHeader" class="flex items-center justify-between px-5 pt-4 pb-2 shrink-0"></div>
    <div id="detailContent" class="p-5 pt-0 overflow-y-auto scrollbar-thin flex-1"></div>
  </div>
</div>

<!-- Stats bar -->
<footer class="flex items-center gap-4 px-4 py-1 bg-raised border-t border-default text-xs text-secondary shrink-0">
  <span>Open: <b id="footOpen" class="text-primary">0</b></span>
  <span>In Progress: <b id="footActive" class="text-primary">0</b></span>
  <span>Ready: <b id="footReady" class="text-emerald-400">0</b></span>
  <span>Blocked: <b id="footBlocked" class="text-red-400">0</b></span>
  <span>Deps: <b id="footDeps" class="text-primary">0</b></span>
  <canvas id="sparkline" width="100" height="20" title="14-day throughput trend" class="opacity-70"></canvas>
  <span id="staleBadge" class="hidden text-xs bg-red-900/50 text-red-400 px-2 py-0.5 rounded border border-red-800 cursor-pointer" onclick="showStaleIssues()" title="WIP issues with no updates for >2 hours. Click to view."></span>
</footer>

<div id="batchBar" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-raised border border-strong rounded-lg px-4 py-2 flex items-center gap-3 shadow-xl hidden z-20">
  <span id="batchCount" class="text-xs text-primary">0 selected</span>
  <button onclick="batchSetPriority()" class="text-xs bg-overlay px-2 py-1 rounded bg-overlay-hover">Set Priority</button>
  <button onclick="batchCloseSelected()" class="text-xs bg-red-900/50 text-red-400 px-2 py-1 rounded border border-red-800 hover:bg-red-900">Close All</button>
  <button onclick="toggleMultiSelect()" class="text-xs text-muted text-primary-hover">Cancel</button>
</div>

<div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2" aria-live="polite"></div>

<script type="module" src="/static/js/app.js"></script>
</body>
</html>
